<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel da Malharia</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_final.ico') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon_final.png') }}">

  <style>
    :root{
      --roxo:#8A00FF; --roxo-hover:#A63DFF;
      --text:#1f1f1f; --muted:#6b6b6b;
      --line:#cfd3dc;
      --line-strong:#b9bfca;
      --bg-soft:#F7F7FA;
      --bg:#ffffff;
      --success:#2e7d32; --warn:#b85e00; --danger:#b00020;
    }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    html, body{ background:var(--bg-soft); color:var(--text); margin:0; }
    th, td{ text-align:center; }

    /* ======= TOPBAR ======= */
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:8px 14px; background:#fff; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:50;
    }
    .topbar .logo img{ height:54px; }
    @media (min-width:901px){ .topbar .logo img{ height:44px; } }
    .topbar .spacer{ flex:1; }

    .top-icons{ display:flex; align-items:center; gap:12px; }
    .badge-wrap{ position:relative; }
    .badge{
      position:absolute; top:-6px; right:-6px; min-width:16px; height:16px;
      padding:0 4px; border-radius:999px; background:#ff6b00; color:#fff;
      font-size:11px; display:flex; align-items:center; justify-content:center; line-height:1;
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:9999px; border:1px solid var(--line);
      background:#fff; cursor:pointer; transition:.18s;
    }
    .icon-btn:hover{ background:#f3f3f7; }
    .icon-btn svg{ width:18px; height:18px; stroke:#444; fill:none; stroke-width:1.8; }

    .profile-pill{
      display:inline-flex; align-items:center; gap:8px; padding:4px 10px;
      border:1px solid var(--line); border-radius:9999px; background:#fff; cursor:pointer;
    }
    .profile-pill .avatar{
      width:24px; height:24px; border-radius:9999px; overflow:hidden; background:#f2f2ff;
      display:grid; place-items:center; border:1px solid var(--line);
    }
    .profile-pill .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .profile-pill .name{ max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; font-size:14px; }
    .caret{ width:14px; height:14px; stroke:#555; }
    @media (max-width:520px){ .profile-pill .name{ display:none; } }

    .profile-menu{
      position:absolute; right:14px; top:56px; width:280px;
      background:#fff; border:1px solid var(--line); border-radius:14px;
      opacity:0; pointer-events:none; transform:translateY(8px) scale(.98);
      transition:opacity .18s ease, transform .18s ease; z-index:60;
    }
    .profile-menu.open{ opacity:1; pointer-events:auto; transform:translateY(0) scale(1); }
    .pm-header{ display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--line); }
    .pm-header .avatar{ width:36px; height:36px; border-radius:9999px; overflow:hidden; border:1px solid var(--line); background:#f2f2ff; display:grid; place-items:center; }
    .pm-header strong{ font-size:14px; }
    .pm-group-title{ font-size:11px; color:#7a7a7a; letter-spacing:.02em; text-transform:uppercase; padding:10px 12px 4px; }
    .pm-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; text-decoration:none; color:#222; }
    .pm-item:hover{ background:#f7f8ff; color:#2a118a; }
    .pm-item svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:1.8; }
    .pm-sep{ height:1px; background:var(--line); margin:6px 0; }

    .notify-panel{
      position:absolute; right:70px; top:56px; width:320px; max-width:92vw;
      background:#fff; border:1px solid var(--line); border-radius:14px;
      opacity:0; pointer-events:none; transform:translateY(8px) scale(.98);
      transition:opacity .18s ease, transform .18s ease; z-index:60;
    }
    .notify-panel.open{ opacity:1; pointer-events:auto; transform:translateY(0) scale(1); }
    .np-header{ padding:10px 12px; border-bottom:1px solid var(--line); font-weight:800; }
    .np-empty{ padding:14px 12px; color:#666; }
    .np-item{ padding:10px 12px; border-bottom:1px solid #f1f2f6; }
    .np-item:last-child{ border-bottom:0; }
    .np-item small{ color:#777; }

    .btn-roxo{
      display:inline-flex; align-items:center; justify-content:center;
      height:40px; padding:0 16px; border:0; border-radius:9999px;
      background:var(--roxo); color:#fff; font-weight:700; font-size:14px;
      text-decoration:none; cursor:pointer; transition:.2s; white-space:nowrap;
    }
    .btn-roxo:hover{ background:var(--roxo-hover); transform:translateY(-1px); }
    .btn-roxo:focus-visible{ outline:3px solid rgba(138,0,255,.25); outline-offset:2px; }

    .container{ max-width:1100px; margin:0 auto; padding:0 16px 28px; }
    h1.titulo{ text-align:center; margin:10px 0 4px; }
    h2{ margin:0; }

    /* ===== HERO com duas colunas ===== */
    .hero-card{
      max-width:1100px; margin:14px auto 8px;
      background:#fff; border:1px solid var(--line);
      border-radius:22px; padding:18px;
      display:grid; grid-template-columns:1.2fr .8fr; gap:20px; align-items:stretch;
    }
    @media (max-width:920px){ .hero-card{ grid-template-columns:1fr; } }

    .hero-ident{ display:flex; gap:14px; align-items:flex-start; min-width:0; position:relative; }
    .hero-avatar{
      width:64px; height:64px; border-radius:50%;
      background: radial-gradient(120% 120% at 10% 10%, #f4f3ff, #f0ecff 60%, #ebe6ff 100%);
      display:grid; place-items:center; flex:0 0 64px; border:1px solid var(--line); position:relative;
      overflow:visible;
    }
    .hero-avatar img{ width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .hero-avatar svg{ width:30px; height:30px; stroke:var(--roxo); fill:none; stroke-width:1.8; }

    .edit-pencil{
      position:absolute; right:-6px; bottom:-6px; width:28px; height:28px; border-radius:9999px;
      border:1px solid var(--line); background:#fff; display:grid; place-items:center; cursor:pointer;
      z-index:2;
    }
    .edit-pencil:hover{ background:#f3f3f7; }
    .edit-pencil svg{ width:16px; height:16px; stroke:#555; fill:none; stroke-width:1.8; }

    /* Popover de opções de foto (desktop e mobile) */
    .photo-menu{
      position:absolute; left:0; bottom:72px; width:240px;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      opacity:0; pointer-events:none; transform:translateY(6px);
      transition:.15s;
      z-index:2000;
    }
    .photo-menu.open{ opacity:1; pointer-events:auto; transform:translateY(0); }
    .photo-item{ display:flex; align-items:center; gap:10px; width:100%; background:transparent; border:0; padding:10px 12px; cursor:pointer; }
    .photo-item:hover{ background:#f6f7fb; }
    .photo-item svg{ width:18px; height:18px; stroke:#444; fill:none; stroke-width:1.8; }

    .hero-nome{ font-size:1.25rem; font-weight:800; color:#161616; line-height:1.2; }
    .hero-chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 12px;
      border-radius:999px; font-weight:700; font-size:.85rem; border:1px solid var(--line);
      background:#fff; color:#333;
    }
    .chip .dot{ width:8px; height:8px; border-radius:50%; }
    .dot-success{ background:var(--success); }
    .dot-warn{ background:var(--warn); }

    /* ===== Coluna direita: Performance (minimalista) ===== */
    .perf-mini{
      border:1px solid var(--line); border-radius:16px; padding:14px; background:#fff;
      display:flex; flex-direction:column; gap:8px; align-items:flex-start; justify-content:center;
    }
    .perf-mini-title{ font-weight:800; }
    .perf-mini-link{ font-weight:800; color:var(--roxo); text-decoration:none; }
    .perf-mini-link:hover{ text-decoration:underline; }

    /* ===== TABELA ===== */
    .table-wrapper{ overflow-x:auto; margin-top:8px; }
    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); }
    thead th{ background:#fafafa; }
    th, td{ padding:10px; border:1px solid var(--line); }
    tbody tr:hover{ background:#fcfcff; }

    .sec-title{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-top:28px; margin-bottom:4px;
    }

    /* ===== Ações por ícone (tabela) ===== */
    .acoes-wrap{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }
    .icon-btn{ width:36px; height:36px; border-radius:9999px; border:1px solid var(--line); background:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:.18s; }
    .icon-btn:hover{ background:#f3f3f7; }
    .icon-btn:focus-visible{ outline:3px solid rgba(138,0,255,.25); outline-offset:2px; }
    .icon-btn svg{ width:18px; height:18px; stroke:#555; fill:none; stroke-width:1.8; }
    .icon-btn.edit:hover svg{ stroke:var(--roxo); }
    .icon-btn.danger:hover svg{ stroke:var(--danger); }

    /* ===== Mobile: cards de teares ===== */
    .teares-cards{ display:none; grid-template-columns:1fr; gap:10px; }
    .tear-card{ border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px; }
    .tear-hd{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .tear-title{ font-weight:800; }
    .tear-actions{ display:flex; gap:8px; margin-left:auto; }
    .tear-body{ display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; }
    .tear-item span{ display:block; font-size:11px; color:#777; }
    .tear-item strong{ font-size:14px; }

    .it-tipo{ grid-column:1 / -1; }
    .it-diametro{ grid-column:auto; }
    .it-finura{ grid-column:auto; }
    .it-alims{ grid-column:auto; }
    .it-elastano{ grid-column:auto; }

    @media (max-width:640px){
      .table-wrapper{ display:none; }
      .teares-cards{ display:grid; }
    }

    /* ===== Modal de Câmera (desktop) ===== */
    .cam-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; z-index:70;
    }
    .cam-overlay.open{ display:flex; }
    .cam-modal{
      width:min(92vw, 520px); background:#fff; border-radius:16px; border:1px solid var(--line);
      padding:12px; display:flex; flex-direction:column; gap:10px;
    }
    .cam-video{ width:100%; background:#000; border-radius:12px; overflow:hidden; }
    .cam-actions{ display:flex; gap:10px; justify-content:flex-end; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; height:40px; padding:0 14px; border-radius:9999px; border:1px solid var(--line); background:#fff; cursor:pointer; }
    .btn-primary{ background:var(--roxo); color:#fff; border:0; }
  </style>
</head>
<body>

{# ===== Variáveis precisam estar antes do <header> para o header usá-las ===== #}
{% set nome_empresa =
    (empresa.apelido if empresa and empresa.apelido else
     (empresa.nome_fantasia if empresa and empresa.nome_fantasia else
      (empresa.razao_social if empresa and empresa.razao_social else 'Minha Malharia'))) %}
{% set _assin_ativa = (assinatura_ativa if assinatura_ativa is defined else False) %}
{% set lista_teares =
    (teares if teares is defined and teares is not none
     else (empresa.teares if empresa and empresa.teares else [])) %}
{# URL do avatar: prioriza a sessão (tem cache-buster), depois o que a view injetar, depois legado foto_url #}
{% set avatar_url = (session.get('avatar_url') or avatar_url or foto_url) %}

<!-- ===== TOPBAR ===== -->
<header class="topbar">
  <a class="logo" href="{{ url_for('index') }}" aria-label="Página inicial" title="Página inicial">
    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="AcheTece">
  </a>
  <div class="spacer"></div>

  {% set chat_count = (chat_nao_lidos if chat_nao_lidos is defined else 0) %}
  {% set notif_count = (notificacoes if notificacoes is defined else 0) %}

  <div class="top-icons">
    <a href="{{ url_for('fale_conosco') }}" class="icon-btn badge-wrap" aria-label="Chat" title="Chat">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path></svg>
      {% if chat_count|int > 0 %}<span class="badge">{{ chat_count }}</span>{% endif %}
    </a>

    <button id="notifToggle" class="icon-btn badge-wrap" aria-label="Notificações" title="Notificações" type="button">
      <svg viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
      {% if notif_count|int > 0 %}<span class="badge">{{ notif_count }}</span>{% endif %}
    </button>
    <nav id="notifPanel" class="notify-panel" aria-label="Notificações" role="dialog" aria-modal="false">
      <div class="np-header">Notificações</div>
      {% if (notificacoes_lista is defined) and notificacoes_lista %}
        {% for n in notificacoes_lista %}
          <div class="np-item">
            <strong>{{ n.titulo }}</strong><br>
            <small>{{ n.mensagem }}</small>
          </div>
        {% endfor %}
      {% else %}
        <div class="np-empty">Nenhuma notificação.</div>
      {% endif %}
    </nav>

    <button class="profile-pill" id="profileToggle" type="button" aria-haspopup="menu" aria-expanded="false" title="Abrir menu do perfil">
      <span class="avatar">
        {% if avatar_url %}
          <img src="{{ avatar_url }}" alt="Foto do perfil">
        {% else %}
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#6a5acd" fill="none" stroke-width="1.8"></circle><path d="M4 20c0-4 4-7 8-7s8 3 8 7" stroke="#6a5acd" fill="none" stroke-width="1.8"></path></svg>
        {% endif %}
      </span>
      <span class="name">{{ nome_empresa }}</span>
      <svg class="caret" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
    </button>
  </div>

  <!-- Dropdown Perfil -->
  <nav class="profile-menu" id="profileMenu" role="menu" aria-label="Menu de perfil">
    <div class="pm-header">
      <span class="avatar">
        {% if avatar_url %}
          <img src="{{ avatar_url }}" alt="Foto do perfil">
        {% else %}
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#6a5acd" fill="none" stroke-width="1.8"></circle><path d="M4 20c0-4 4-7 8-7s8 3 8 7" stroke="#6a5acd" fill="none" stroke-width="1.8"></path></svg>
        {% endif %}
      </span>
      <div>
        <strong>{{ nome_empresa }}</strong><br>
        <small style="color:#777">Meu perfil</small>
      </div>
    </div>

    <div class="pm-group-title">Minha conta</div>
    <a href="{{ url_for('editar_empresa') }}" class="pm-item" role="menuitem" title="Editar cadastro">
      <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
      <span>Editar cadastro</span>
    </a>
    <a href="{{ url_for('performance_acesso') }}" class="pm-item" role="menuitem" title="Ver performance de acesso">
      <svg viewBox="0 0 24 24"><path d="M3 3v18h18"></path><path d="M7 13l3 3 7-7"></path></svg>
      <span>Performance de acesso</span>
    </a>

    <div class="pm-group-title">Assinatura</div>
    {% if assinatura_ativa %}
      <a href="{{ url_for('checkout', plano=empresa.plano or 'mensal') }}" class="pm-item" role="menuitem" title="Gerenciar pagamento">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M3 10h18"></path></svg>
        <span>Minha assinatura (ativa)</span>
      </a>
    {% else %}
      <a href="{{ url_for('checkout', plano='mensal') }}" class="pm-item" role="menuitem" title="Pagar assinatura">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M3 10h18"></path></svg>
        <span>Assinatura pendente (pagar)</span>
      </a>
    {% endif %}

    <div class="pm-sep"></div>

    <a href="{{ url_for('fale_conosco') }}" class="pm-item" role="menuitem" title="Falar com o suporte">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path></svg>
      <span>Suporte AcheTece</span>
    </a>
    <a href="{{ url_for('logout') }}" class="pm-item" role="menuitem" title="Sair">
      <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><path d="M16 17l5-5-5-5"></path><path d="M21 12H9"></path></svg>
      <span>Sair</span>
    </a>
  </nav>

  <!-- form oculto para upload de foto -->
  <form id="fotoForm" action="{{ url_for('perfil_foto_upload') }}" method="POST" enctype="multipart/form-data" class="sr-only">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <!-- Fototeca (galeria) -->
    <input type="file" id="fotoInputLib"  name="foto" accept="image/*">
    <!-- Câmera (mobile) -->
    <input type="file" id="fotoInputCam"  name="foto" accept="image/*" capture="environment">
    <!-- Arquivo tradicional -->
    <input type="file" id="fotoInputFile" name="foto" accept="image/*,.jpg,.jpeg,.png,.webp,.gif">
  </form>
</header>

<div class="container">
  <h1 class="titulo">Painel da Malharia</h1>
  <p style="text-align:center;">Bem-vindo(a), <strong>{{ nome_empresa }}</strong>!</p>

  <!-- ===== HERO ===== -->
  <div class="hero-card">
    <!-- Coluna esquerda -->
    <div>
      <div class="hero-ident">
        <div class="hero-avatar" aria-label="Foto do perfil" title="Clique no lápis para alterar a foto">
          {% if avatar_url %}
            <img src="{{ avatar_url }}" alt="">
          {% else %}
            <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-7 8-7s8 3 8 7"></path></svg>
          {% endif %}
          <button class="edit-pencil" id="pencilToggle" type="button" title="Alterar foto do perfil">
            <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
          </button>

          <!-- Popover com as 3 opções -->
          <div id="photoMenu" class="photo-menu" aria-label="Opções da foto" role="menu">
            <button type="button" class="photo-item" data-act="gallery">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="8.5" cy="11.5" r="2.5"></circle><path d="M21 15l-5-5-4 4-2-2-5 5"></path></svg>
              <span>Fototeca</span>
            </button>
            <button type="button" class="photo-item" data-act="camera">
              <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"></rect><path d="M8 7l2-3h4l2 3"></path><circle cx="12" cy="14" r="3.5"></circle></svg>
              <span>Tirar foto</span>
            </button>
            <button type="button" class="photo-item" data-act="file">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path></svg>
              <span>Escolher arquivo</span>
            </button>
          </div>
        </div> <!-- FECHA hero-avatar -->

        <div class="hero-info" style="min-width:0;">
          <div class="hero-nome">{{ nome_empresa }}</div>

          <div class="hero-chips">
            {% if _assin_ativa %}
              <span class="chip" title="Assinatura ativa"><span class="dot dot-success"></span>Assinatura ativa</span>
            {% else %}
              <a class="chip" href="{{ url_for('checkout', plano='mensal') }}" title="Pagar assinatura">
                <span class="dot dot-warn"></span>Assinatura pendente
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna direita: Performance (apenas título + link) -->
    <aside class="perf-mini">
      <div class="perf-mini-title">Performance de acesso</div>
      <a href="{{ url_for('performance_acesso') }}" class="perf-mini-link">Ver detalhes</a>
    </aside>
  </div>
  <!-- ===== /HERO ===== -->

  <!-- Cabeçalho da tabela -->
  <div class="sec-title">
    <h2>Teares Cadastrados:</h2>
    <a href="{{ url_for('teares_form') }}" class="btn-roxo">+ Cadastrar Tear</a>
  </div>

  <!-- Desktop: tabela -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Marca</th><th>Modelo</th><th>Tipo</th>
          <th>Finura</th><th>Diâmetro</th>
          <th>Alimentadores</th><th>Elastano</th><th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% if lista_teares|length %}
          {% for tear in lista_teares %}
          <tr>
            <td>{{ tear.marca or '-' }}</td>
            <td>{{ tear.modelo or '-' }}</td>
            <td>{{ tear.tipo or '-' }}</td>
            <td>{{ tear.finura if tear.finura is not none else '-' }}</td>
            <td>{{ tear.diametro if tear.diametro is not none else '-' }}</td>
            <td>{{ tear.alimentadores if tear.alimentadores is not none else '-' }}</td>
            <td>{{ 'Sim' if (tear.elastano or tear.kit_elastano) else 'Não' }}</td>
            <td>
              <div class="acoes-wrap">
                <a href="{{ url_for('editar_tear', id=tear.id) }}" class="icon-btn edit" title="Editar tear" aria-label="Editar">
                  <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                  <span class="sr-only">Editar</span>
                </a>
                <form method="POST"
                      action="{{ url_for('excluir_tear', id=tear.id) }}"
                      onsubmit="return confirm('Confirma excluir este tear? Essa ação é irreversível.');"
                      style="display:inline">
                  <input type="hidden" name="next" value="{{ url_for('painel_malharia') }}">
                  <button type="submit" class="icon-btn danger" title="Excluir tear" aria-label="Excluir">
                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
                    <span class="sr-only">Excluir</span>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8">Nenhum tear cadastrado ainda.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Mobile: cards -->
  <div class="teares-cards">
    {% if lista_teares|length %}
      {% for tear in lista_teares %}
        <div class="tear-card">
          <div class="tear-hd">
            <div class="tear-title">{{ tear.marca or '-' }} — {{ tear.modelo or '-' }}</div>
            <div class="tear-actions">
              <a href="{{ url_for('editar_tear', id=tear.id) }}" class="icon-btn edit" title="Editar">
                <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </a>
              <form method="POST"
                    action="{{ url_for('excluir_tear', id=tear.id) }}"
                    onsubmit="return confirm('Confirma excluir este tear? Essa ação é irreversível.');">
                <input type="hidden" name="next" value="{{ url_for('painel_malharia') }}">
                <button type="submit" class="icon-btn danger" title="Excluir">
                  <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
                </button>
              </form>
            </div>
          </div>

          <div class="tear-body">
            <div class="tear-item it-tipo"><span>Tipo</span><strong>{{ tear.tipo or '-' }}</strong></div>
            <div class="tear-item it-diametro"><span>Diâmetro</span><strong>{{ tear.diametro if tear.diametro is not none else '-' }}</strong></div>
            <div class="tear-item it-finura"><span>Finura</span><strong>{{ tear.finura if tear.finura is not none else '-' }}</strong></div>
            <div class="tear-item it-alims"><span>Alimentadores</span><strong>{{ tear.alimentadores if tear.alimentadores is not none else '-' }}</strong></div>
            <div class="tear-item it-elastano"><span>Elastano</span><strong>{{ 'Sim' if (tear.elastano or tear.kit_elastano) else 'Não' }}</strong></div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="tear-card">Nenhum tear cadastrado ainda.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Webcam (desktop) -->
<div id="camOverlay" class="cam-overlay" aria-hidden="true">
  <div class="cam-modal" role="dialog" aria-modal="true" aria-label="Capturar foto">
    <video id="camVideo" class="cam-video" autoplay playsinline></video>
    <canvas id="camCanvas" class="sr-only"></canvas>
    <div class="cam-actions">
      <button type="button" class="btn" id="camCancel">Cancelar</button>
      <button type="button" class="btn btn-primary" id="camShot">Capturar</button>
    </div>
  </div>
</div>

<!-- Overlay transparente global (NÃO fica dentro do hero) -->
<div id="photoOverlay" class="photo-overlay" hidden></div>

<script>
  (function(){
    // menu perfil
    const toggle = document.getElementById('profileToggle');
    const menu   = document.getElementById('profileMenu');
    function closeMenu(){ menu.classList.remove('open'); toggle?.setAttribute('aria-expanded','false'); }
    function openMenu(){  menu.classList.add('open');    toggle?.setAttribute('aria-expanded','true'); }
    function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }
    toggle?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });

    // notificações
    const nbtn = document.getElementById('notifToggle');
    const npanel = document.getElementById('notifPanel');
    function closeNotif(){ npanel.classList.remove('open'); }
    function toggleNotif(e){ e.stopPropagation(); npanel.classList.toggle('open'); }
    nbtn?.addEventListener('click', toggleNotif);

    // fechar quando clicar fora / ESC
    document.addEventListener('click', ()=>{ closeMenu(); closeNotif(); closePhotoMenu(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); closeNotif(); closePhotoMenu(); closeCam(); }});
    menu?.addEventListener('click', (e)=> e.stopPropagation());
    npanel?.addEventListener('click', (e)=> e.stopPropagation());

    // ===== Upload de foto - opções (MOBILE FIX) =====
    const fotoForm  = document.getElementById('fotoForm');
    const inLib     = document.getElementById('fotoInputLib');
    const inCam     = document.getElementById('fotoInputCam');
    const inFile    = document.getElementById('fotoInputFile');
    const pencil    = document.getElementById('pencilToggle');
    const photoMenu = document.getElementById('photoMenu');
    const overlay   = document.getElementById('photoOverlay');

    function openPhotoMenu(){
      photoMenu.classList.add('open');
      if (overlay) overlay.hidden = false;
    }
    function closePhotoMenu(){
      photoMenu.classList.remove('open');
      if (overlay) overlay.hidden = true;
    }

    overlay?.addEventListener('click', (e)=>{ e.stopPropagation(); closePhotoMenu(); });

    pencil?.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      if (photoMenu.classList.contains('open')) closePhotoMenu(); else openPhotoMenu();
    });
    photoMenu?.addEventListener('click', (e)=>{ e.stopPropagation(); });

    function triggerInput(inputEl){
      try { inputEl.click(); } catch(e) { setTimeout(()=>inputEl.click(), 0); }
    }

    photoMenu?.querySelectorAll('.photo-item').forEach(btn=>{
      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        const act = btn.getAttribute('data-act');
        if (act === 'gallery'){
          inLib.value = ""; triggerInput(inLib);
        } else if (act === 'file'){
          inFile.value = ""; triggerInput(inFile);
        } else if (act === 'camera'){
          const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
          if (isMobile){
            inCam.value = ""; triggerInput(inCam);
          } else {
            openCam();
          }
        }
      }, {passive:false});
    });

    function afterPick(){ closePhotoMenu(); }

    function submitIfFile(inputEl){
      afterPick();
      if (inputEl?.files && inputEl.files.length > 0){
        if (fotoForm?.requestSubmit) fotoForm.requestSubmit(); else fotoForm?.submit();
      }
    }
    inLib?.addEventListener('change', function(){ submitIfFile(this); });
    inFile?.addEventListener('change', function(){ submitIfFile(this); });
    inCam?.addEventListener('change', function(){ submitIfFile(this); });

    // ===== Webcam (desktop) =====
    const camOverlay = document.getElementById('camOverlay');
    const camVideo   = document.getElementById('camVideo');
    const camCanvas  = document.getElementById('camCanvas');
    const camCancel  = document.getElementById('camCancel');
    const camShot    = document.getElementById('camShot');
    let camStream = null;

    async function openCam(){
      try{
        camStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        camVideo.srcObject = camStream;
        camOverlay.classList.add('open');
        if (overlay) overlay.hidden = false;
      }catch(err){
        alert('Não foi possível acessar a câmera. Se preferir, use "Escolher arquivo".');
        if (overlay) overlay.hidden = true;
      }
    }
    function closeCam(){
      camOverlay.classList.remove('open');
      if (overlay) overlay.hidden = true;
      if (camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
    }
    camCancel?.addEventListener('click', closeCam);

    camShot?.addEventListener('click', async ()=>{
      if (!camVideo.videoWidth){ return; }
      const w = camVideo.videoWidth, h = camVideo.videoHeight;
      camCanvas.width = w; camCanvas.height = h;
      const ctx = camCanvas.getContext('2d');
      ctx.drawImage(camVideo, 0, 0, w, h);
      camCanvas.toBlob(async (blob)=>{
        if (!blob) return;
        const fd = new FormData();
        const csrf = fotoForm.querySelector('input[name="csrf_token"]')?.value;
        if (csrf) fd.append('csrf_token', csrf);
        fd.append('foto', blob, 'camera.jpg');

        try{
          const resp = await fetch(fotoForm.action, { method:'POST', body: fd, credentials:'same-origin' });
          if (resp.ok){
            closeCam();
            location.reload();
          }else{
            closeCam();
            alert('Falha ao enviar a foto.');
          }
        }catch(e){
          closeCam();
          alert('Erro ao enviar a foto.');
        }
      }, 'image/jpeg', 0.92);
    });

    // Fechamentos globais
    document.addEventListener('click', ()=>{ closeMenu(); closeNotif(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); closeNotif(); closePhotoMenu(); closeCam(); }});
  })();
</script>
</body>
</html>
