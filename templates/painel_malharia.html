<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel da Malharia</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_final.ico') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon_final.png') }}">

  <style>
  :root{
    /* Paleta OLIVE (padrão novo) */
    --olive:#7B7424;
    --olive-600:#5E581C;
    --olive-dark:#434326;
    --olive-50:#F1F2E8;
    --line-olive:#BFBFA8;

    /* Destaque neon para CTAs */
    --lime:#B6F34D;
    --lime-700:#A2E532;

    /* Fundo global igual à index */
    --site-bg:#EAEAE8;

    /* Compat/legado + neutros */
    --text:#1f1f1f; --muted:#6b6b6b;
    --line:#cfd3dc; --line-strong:#b9bfca;
    --bg:#ffffff; --bg-soft:var(--site-bg);
    --success:#2e7d32; --warn:#b85e00; --danger:#b00020;

    /* Aliases para CSS antigo */
    --roxo:var(--olive);
    --roxo-hover:var(--olive-600);
  }

  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  html, body{ background:var(--bg-soft); color:var(--text); margin:0; }
  th, td{ text-align:center; }

  /* ======= TOPBAR ======= */
  .topbar{
    display:flex; align-items:center; gap:12px;
    padding:8px 14px; background:#fff; border-bottom:1px solid var(--line);
    position:sticky; top:0; z-index:50;
  }
  .topbar .logo img{ height:54px; }
  @media (min-width:901px){ .topbar .logo img{ height:44px; } }
  .topbar .spacer{ flex:1; }

  .top-icons{ display:flex; align-items:center; gap:12px; }
  .badge-wrap{ position:relative; }
  .badge{
    position:absolute; top:-6px; right:-6px; min-width:16px; height:16px;
    padding:0 4px; border-radius:999px; background:#ff6b00; color:#fff;
    font-size:11px; display:flex; align-items:center; justify-content:center; line-height:1;
  }

  .icon-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border-radius:9999px; border:1px solid var(--line);
    background:#fff; cursor:pointer; transition:.18s background-color, .18s transform;
    box-shadow:none !important;
  }
  .icon-btn:hover{ background:var(--olive-50); transform:translateY(-1px); }
  .icon-btn:focus-visible{ outline:2px solid var(--lime); outline-offset:2px; }
  .icon-btn svg{ width:18px; height:18px; stroke:#444; fill:none; stroke-width:1.8; }

  .profile-pill{
    display:inline-flex; align-items:center; gap:8px; padding:4px 10px;
    border:1px solid var(--line); border-radius:9999px; background:#fff; cursor:pointer;
    box-shadow:none !important;
  }
  .profile-pill .avatar{
    width:24px; height:24px; border-radius:50%; overflow:hidden; background:#f2f2ff;
    display:grid; place-items:center; border:1px solid var(--line);
  }
  .profile-pill .name{ max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; font-size:14px; }
  .caret{ width:14px; height:14px; stroke:#555; }
  @media (max-width:520px){ .profile-pill .name{ display:none; } }

  .profile-menu{
    position:absolute; right:14px; top:56px; width:280px;
    background:#fff; border:1px solid var(--line); border-radius:14px;
    opacity:0; pointer-events:none; transform:translateY(8px) scale(.98);
    transition:opacity .18s ease, transform .18s ease; z-index:60;
  }
  .profile-menu.open{ opacity:1; pointer-events:auto; transform:translateY(0) scale(1); }
  .pm-header{ display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--line); }
  .pm-header .avatar{
    width:24px; height:24px; border-radius:50%; overflow:hidden; background:#f2f2ff;
    display:grid; place-items:center; border:1px solid var(--line);
  }
  .pm-group-title{ font-size:11px; color:#7a7a7a; letter-spacing:.02em; text-transform:uppercase; padding:10px 12px 4px; }
  .pm-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; text-decoration:none; color:#222; }
  .pm-item:hover{ background:var(--olive-50); color:var(--olive); border-radius:8px; }
  .pm-item svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:1.8; }
  .pm-sep{ height:1px; background:var(--line); margin:6px 0; }

  .notify-panel{
    position:absolute; right:70px; top:56px; width:320px; max-width:92vw;
    background:#fff; border:1px solid var(--line); border-radius:14px;
    opacity:0; pointer-events:none; transform:translateY(8px) scale(.98);
    transition:opacity .18s ease, transform .18s ease; z-index:60;
  }
  .notify-panel.open{ opacity:1; pointer-events:auto; transform:translateY(0) scale(1); }
  .np-header{ padding:10px 12px; border-bottom:1px solid var(--line); font-weight:800; }
  .np-empty{ padding:14px 12px; color:#666; }
  .np-item{ padding:10px 12px; border-bottom:1px solid #f1f2f6; }
  .np-item:last-child{ border-bottom:0; }
  .np-item small{ color:#777; }

  /* ===== BOTÕES PADRÃO (preto → lime no hover; SEM borda no hover) ===== */
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    height:40px; padding:0 16px; border-radius:9999px; border:0;
    background:#000; color:var(--lime); font-weight:800; font-size:14px;
    text-decoration:none; cursor:pointer; transition:.15s background-color, .15s color, .15s transform;
    box-shadow:none !important;
  }
  .btn:hover{ background:var(--lime); color:#000; transform:translateY(-2px); }
  .btn:active{ background:var(--lime-700); color:#000; transform:translateY(0); }
  .btn:focus-visible{ outline:2px solid var(--lime); outline-offset:2px; }

  /* Versão “marca” (antes .btn-roxo) — agora OLIVE */
  .btn-roxo{
    display:inline-flex; align-items:center; justify-content:center;
    height:40px; padding:0 16px; border:0; border-radius:9999px;
    background:var(--olive); color:#fff; font-weight:800; font-size:14px;
    text-decoration:none; cursor:pointer; transition:.15s background-color, .15s transform;
    box-shadow:none !important;
  }
  .btn-roxo:hover{ background:var(--olive-600); transform:translateY(-1px); }
  .btn-roxo:focus-visible{ outline:2px solid var(--lime); outline-offset:2px; }

  .container{ max-width:1100px; margin:0 auto; padding:0 16px 28px; }
  h1.titulo{ text-align:center; margin:10px 0 4px; color:var(--olive-dark); }
  h2{ margin:0; color:#1d1d1d; }

  /* ===== HERO com duas colunas ===== */
  .hero-card{
    max-width:1100px; margin:14px auto 8px;
    background:#fff; border:1px solid var(--line);
    border-radius:22px; padding:18px;
    display:grid; grid-template-columns:1.2fr .8fr; gap:20px; align-items:stretch;
  }
  @media (max-width:920px){ .hero-card{ grid-template-columns:1fr; } }
  .hero-ident{ display:flex; gap:14px; align-items:flex-start; min-width:0; position:relative; }

  /* ===== AVATARES DO TOPO/DROPDOWN e HERO ===== */
  .profile-pill .avatar,
  .pm-header .avatar{
    width:24px; height:24px; border-radius:50%; border:1px solid var(--line); background:#f2f2ff;
    position:relative; overflow:hidden; line-height:0; display:block;
  }
  .hero-avatar{
    width:64px; height:64px; border-radius:50%; border:1px solid var(--line);
    background: radial-gradient(120% 120% at 10% 10%, #f4f3ff, #f0ecff 60%, #ebe6ff 100%);
    position:relative; overflow:visible; line-height:0; display:block; flex:0 0 64px;
  }
  .profile-pill .avatar > img.js-avatar,
  .pm-header .avatar > img.js-avatar,
  .hero-avatar > img.js-avatar{
    position:absolute !important; inset:0 !important;
    width:100% !important; height:100% !important; max-width:none !important; max-height:none !important;
    display:block !important; object-fit:cover !important; object-position:50% 50% !important;
    border-radius:50% !important;
    -webkit-mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
    mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
    aspect-ratio:auto !important; z-index:1; -webkit-user-drag:none; user-select:none;
  }
  .hero-avatar svg{ width:30px; height:30px; stroke:var(--olive); fill:none; stroke-width:1.8; }

  /* ===== Botão do lápis (editar foto) ===== */
  .edit-pencil{
    position:absolute; right:-6px; bottom:-6px; width:28px; height:28px; border-radius:9999px;
    border:1px solid var(--line); background:#fff; display:grid; place-items:center; cursor:pointer;
    z-index:3001; box-shadow:0 2px 6px rgba(0,0,0,.08);
    transition:transform .12s ease, background .12s ease;
  }
  .edit-pencil:hover{ background:var(--olive-50); transform:translateY(-1px); }
  .edit-pencil:focus-visible{ outline:2px solid var(--lime); outline-offset:2px; }
  .edit-pencil svg{ width:16px; height:16px; stroke:#555; fill:none; stroke-width:1.8; }

  /* ===== Popover de opções ===== */
  .photo-menu{
    position:absolute; left:0; bottom:72px; width:240px;
    background:#fff; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    opacity:0; pointer-events:none; transform:translateY(6px);
    transition:.15s; z-index:3000;
  }
  .photo-menu.open{ opacity:1; pointer-events:auto; transform:translateY(0); }
  .photo-item{ display:flex; align-items:center; gap:10px; width:100%; background:transparent; border:0; padding:10px 12px; cursor:pointer; }
  .photo-item:hover{ background:#f6f7fb; }
  .photo-item:focus-visible{ outline:2px solid var(--lime); outline-offset:2px; }
  .photo-item svg{ width:18px; height:18px; stroke:#444; fill:none; stroke-width:1.8; flex:0 0 18px; }
  .photo-overlay{ position:fixed; inset:0; background:transparent; z-index:1200; }

  .hero-nome{ font-size:1.25rem; font-weight:800; color:#161616; line-height:1.2; }
  .hero-chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .chip{
    display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 12px;
    border-radius:999px; font-weight:700; font-size:.85rem; border:1px solid var(--line);
    background:#fff; color:#333;
  }
  .chip .dot{ width:8px; height:8px; border-radius:50%; }
  .dot-success{ background:var(--success); }
  .dot-warn{ background:var(--warn); }

  /* ===== Coluna direita: Performance ===== */
  .perf-mini{
    border:1px solid var(--line); border-radius:16px; padding:14px; background:#fff;
    display:flex; flex-direction:column; gap:8px; align-items:flex-start; justify-content:center;
  }
  .perf-mini-title{ font-weight:800; color:var(--olive-dark); }
  .perf-mini-link{ font-weight:800; color:var(--olive); text-decoration:none; }
  .perf-mini-link:hover{ text-decoration:underline; }

  /* ===== TABELA ===== */
  .table-wrapper{ overflow-x:auto; margin-top:8px; }
  table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); }
  thead th{ background:#fafafa; }
  th, td{ padding:10px; border:1px solid var(--line); }
  tbody tr:hover{ background:#fcfcff; }

  /* ===== Override: tabela igual à index (cabeçalho OLIVE + zebra) ===== */
  .table-wrapper table thead th{
    background: var(--olive) !important;   /* mesmo header da index */
    color:#fff !important;
    border-color: var(--olive-600) !important;
    font-weight:600;
  }
  
  /* Listras de linhas (iguais à index) */
  .table-wrapper table tbody tr:nth-child(odd){  background:#fff; }
  .table-wrapper table tbody tr:nth-child(even){ background:var(--olive-50); }
  
  /* Bordas do corpo mais suaves, combinando com a paleta */
  .table-wrapper table tbody td{
    border-color: var(--line-olive);
  }
    
  .sec-title{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    margin-top:28px; margin-bottom:4px;
  }

  /* ===== Ações por ícone ===== */
  .acoes-wrap{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }
  .icon-btn.edit:hover svg{ stroke:var(--olive); }
  .icon-btn.danger:hover svg{ stroke:var(--danger); }

  /* ===== Mobile: cards ===== */
  .teares-cards{ display:none; grid-template-columns:1fr; gap:10px; }
  .tear-card{ border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px; }
  .tear-hd{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .tear-title{ font-weight:800; color:#1d1d1d; }
  .tear-actions{ display:flex; gap:8px; margin-left:auto; }
  .tear-body{ display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; }
  .tear-item span{ display:block; font-size:11px; color:#777; }
  .tear-item strong{ font-size:14px; color:#222; }

  .it-tipo{ grid-column:1 / -1; }
  .it-diametro{ grid-column:auto; }
  .it-finura{ grid-column:auto; }
  .it-alims{ grid-column:auto; }
  .it-elastano{ grid-column:auto; }

  @media (max-width:640px){
    .table-wrapper{ display:none; }
    .teares-cards{ display:grid; }
  }

  /* ===== Modal de Câmera ===== */
  .cam-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.65);
    display:none; align-items:center; justify-content:center; z-index:70;
  }
  .cam-overlay.open{ display:flex; }
  .cam-modal{
    width:min(92vw, 520px); background:#fff; border-radius:16px; border:1px solid var(--line);
    padding:12px; display:flex; flex-direction:column; gap:10px;
  }
  .cam-video{ width:100%; background:#000; border-radius:12px; overflow:hidden; }
  .cam-actions{ display:flex; gap:10px; justify-content:flex-end; }
  .btn-primary{ composes: btn; } /* (se usar PostCSS) */
  .cam-actions .btn{ background:#000; color:var(--lime); }
  .cam-actions .btn:hover{ background:var(--lime); color:#000; transform:translateY(-2px); }
  .cam-actions .btn:active{ background:var(--lime-700); color:#000; transform:translateY(0); }
  /* === Override: botão "+ Cadastrar Tear" no padrão global (preto → lime) === */
  button.btn-roxo,
  a.btn-roxo,
  .btn-roxo{
    background:#000 !important;
    color:var(--lime) !important;
    border:0;
    height:40px;
    padding:0 18px;
    border-radius:9999px;
    font-weight:800;
    text-decoration:none;
    cursor:pointer;
    transition: background-color .15s ease, color .15s ease, transform .12s ease;
    box-shadow:none !important;         /* sem anel/sombra no hover */
  }
  
  .btn-roxo:hover{
    background:var(--lime) !important;
    color:#000 !important;
    transform:translateY(-2px);
  }
  
  .btn-roxo:active{
    background:var(--lime-700) !important;
    color:#000 !important;
    transform:translateY(0);
  }
  
  .btn-roxo:focus{ outline:none; }       /* evita borda azul ao clicar */
  .btn-roxo:focus-visible{
    outline:2px solid var(--lime);
    outline-offset:2px;
  }

  /* ===== Cabeçalho da tabela igual ao da index ===== */
  :root{
    /* pode ajustar aqui se quiser refinar depois */
    --tbl-head-bg:#ECECF3;      /* fundo do cabeçalho */
    --tbl-head-text:#1F1F1F;    /* texto do cabeçalho */
    --tbl-head-border:#E3E3E7;  /* bordas do cabeçalho/tabela */
  }
  
  /* aplica ao cabeçalho */
  .table-wrapper table thead th{
    background: var(--tbl-head-bg) !important;
    color: var(--tbl-head-text);
    font-weight: 800;
    border-color: var(--tbl-head-border) !important;
  }
  
  /* linha inferior do thead para separar do corpo */
  .table-wrapper table thead tr{
    border-bottom: 1px solid var(--tbl-head-border);
  }
  
  /* harmoniza toda a tabela com as mesmas bordas */
  .table-wrapper table{
    border-color: var(--tbl-head-border);
  }
  .table-wrapper table th,
  .table-wrapper table td{
    border-color: var(--tbl-head-border);
  }
  /* Cabeçalho da tabela igual ao da index (olive exato) */
  .table-wrapper table thead th{
    background:#7B7424 !important;  /* mesma cor do header da index */
    color:#fff !important;
    border-color:#5E581C !important; /* linha combina com o header */
  }

  /* === Desktop: suaviza pesos de fonte para evitar excesso de contraste === */
  @media (min-width: 901px){
    /* Títulos e headings */
    h1.titulo{ font-weight:700; }               /* antes 800 */
    .hero-nome{ font-weight:700; }              /* antes 800 */
    .sec-title h2,
    h2{ font-weight:700; }                      /* antes 800 */
    .perf-mini-title{ font-weight:700; }        /* antes 800 */
  
    /* Chips/pílulas e textos fortes */
    .chip{ font-weight:600; }                   /* antes 700 */
    .pill{ font-weight:700; }                   /* mantém destaque, mas menos intenso */
    tbody td strong,
    .tear-item strong{ font-weight:600; }       /* antes 700/800 */
  
    /* Cabeçalho da tabela (mantém a cor OLIVE) com peso mais leve */
    .table-wrapper thead th{ font-weight:600; } /* antes 700/800 */
  
    /* Nome na pílula do perfil (suave) */
    .profile-pill .name{ font-weight:600; }     /* antes 700 */
  
    /* Links de performance (mantém ênfase moderada) */
    .perf-mini-link{ font-weight:700; }         /* antes 800 */
  }

  /* === Suavização extra (apenas desktop) === */
  @media (min-width: 901px){
  
    /* 1) Cabeçalho da tabela: menos “negrito” */
    .table-wrapper thead th,
    table thead th{
      font-weight: 500 !important; /* estava 600/700 */
    }
  
    /* 2) Botão “+ Cadastrar Tear”: suaviza o peso apenas no botão da seção */
    .sec-title .btn,
    .sec-title .btn-roxo{
      font-weight: 600 !important; /* estava 800 */
    }
  }

  /* Ícone compactado dentro da chip de vencimento */
  .chip .ico{
    width:14px;
    height:14px;
    stroke:currentColor;
    fill:none;
    stroke-width:1.8;
  }

  /* ===== Ajustes específicos para CELULAR (até 520px) ===== */
  @media (max-width:520px){

    /* Deixa os chips mais “soltos” para não quebrar estranho */
    .hero-chips{
      gap:6px;
      align-items:flex-start;
    }

    .hero-chips .chip{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      height:auto;                 /* não força 32px */
      padding:6px 10px;            /* um pouco mais de respiro */
      gap:6px;
      font-size:0.80rem;           /* levemente menor no mobile */
      max-width:100%;
      line-height:1.3;
    }

    .hero-chips .chip .ico{
      margin-top:1px;              /* ícone alinhado ao texto */
      flex-shrink:0;
    }

    .hero-chips .chip span{
      white-space:normal;          /* permite quebrar em mais de uma linha */
    }

    /* ===== Título + botão "+ Cadastrar Tear" no mobile ===== */

    .sec-title{
      flex-direction:column;       /* título em cima, botão embaixo */
      align-items:flex-start;
      gap:4px;
    }

    /* diminui um pouco o "Teares Cadastrados" só no celular */
    .sec-title h2{
      font-size:1rem;
      margin:0;
    }

    .sec-title .btn-roxo{
      align-self:flex-start;       /* botão começa alinhado à esquerda */
      height:36px;
      font-size:13px;
      padding:0 14px;
    }

    /* === Ajustes extras do chip de vencimento === */
    .hero-chips .chip-venc{
      white-space:nowrap;
    }
  
    .hero-chips .chip-venc .chip-text{
      white-space:nowrap;
    }

    /* === Ajuste de layout da seção de teares no MOBILE === */
    @media (max-width:520px){
  
      /* já aproveitamos e refinamos um pouco o chip */
      .hero-chips{
        gap:6px;
      }
  
      .hero-chips .chip-venc{
        font-size:0.80rem;
        padding:4px 8px;
      }
  
      /* título + botão na mesma linha */
      .sec-title{
        flex-direction:row;          /* garante lado a lado */
        align-items:center;
        justify-content:space-between;
        gap:6px;
        flex-wrap:nowrap;
      }
  
      /* diminui um pouco o "Teares Cadastrados" só no celular */
      .sec-title h2{
        font-size:0.95rem;
        margin:0;
      }
  
      /* botão mais compacto para caber na linha */
      .sec-title .btn-roxo{
        height:32px;
        font-size:0.80rem;
        padding:0 10px;
        white-space:nowrap;
      }
  }
</style>
</head>
<body>

{% set nome_empresa =
    (empresa.apelido if empresa and empresa.apelido else
     (empresa.nome_fantasia if empresa and empresa.nome_fantasia else
      (empresa.razao_social if empresa and empresa.razao_social else 'Minha Malharia'))) %}
{% set _assin_ativa = (assinatura_ativa if assinatura_ativa is defined else False) %}
{% set lista_teares =
    (teares if teares is defined and teares is not none
     else (empresa.teares if empresa and empresa.teares else [])) %}
{# AQUI: fonte única de avatar no painel #}
{% set avatar_url = foto_url %}}

<header class="topbar">
  <a class="logo" href="{{ url_for('index') }}" aria-label="Página inicial" title="Página inicial">
    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="AcheTece">
  </a>
  <div class="spacer"></div>

  {% set chat_count = (chat_nao_lidos if chat_nao_lidos is defined else 0) %}
  {% set notif_count = (notificacoes if notificacoes is defined else 0) %}

  <div class="top-icons">
    <a href="{{ url_for('fale_conosco') }}" class="icon-btn badge-wrap" aria-label="Chat" title="Chat">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path></svg>
      {% if chat_count|int > 0 %}<span class="badge">{{ chat_count }}</span>{% endif %}
    </a>

    <button id="notifToggle" class="icon-btn badge-wrap" aria-label="Notificações" title="Notificações" type="button">
      <svg viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
      {% if notif_count|int > 0 %}<span class="badge">{{ notif_count }}</span>{% endif %}
    </button>
    <nav id="notifPanel" class="notify-panel" aria-label="Notificações" role="dialog" aria-modal="false">
      <div class="np-header">Notificações</div>
      {% if (notificacoes_lista is defined) and notificacoes_lista %}
        {% for n in notificacoes_lista %}
          <div class="np-item">
            <strong>{{ n.titulo }}</strong><br>
            <small>{{ n.mensagem }}</small>
          </div>
        {% endfor %}
      {% else %}
        <div class="np-empty">Nenhuma notificação.</div>
      {% endif %}
    </nav>

    <button class="profile-pill" id="profileToggle" type="button" aria-haspopup="menu" aria-expanded="false" title="Abrir menu do perfil">
      <span class="avatar">
        {% if avatar_url %}
          <img class="js-avatar" src="{{ avatar_url }}" alt="Foto do perfil" decoding="async" referrerpolicy="no-referrer" draggable="false">
        {% else %}
          <img class="js-avatar" src="" alt="Foto do perfil" style="display:none">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#6a5acd" fill="none" stroke-width="1.8"></circle><path d="M4 20c0-4 4-7 8-7s8 3 8 7" stroke="#6a5acd" fill="none" stroke-width="1.8"></path></svg>
        {% endif %}
      </span>
      <span class="name">{{ nome_empresa }}</span>
      <svg class="caret" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
    </button>
  </div>

  <!-- Dropdown Perfil -->
  <nav class="profile-menu" id="profileMenu" role="menu" aria-label="Menu de perfil">
    <div class="pm-header">
      <span class="avatar">
        {% if avatar_url %}
          <img class="js-avatar" src="{{ avatar_url }}" alt="Foto do perfil" decoding="async" referrerpolicy="no-referrer" draggable="false">
        {% else %}
          <img class="js-avatar" src="" alt="Foto do perfil" style="display:none">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#6a5acd" fill="none" stroke-width="1.8"></circle><path d="M4 20c0-4 4-7 8-7s8 3 8 7" stroke="#6a5acd" fill="none" stroke-width="1.8"></path></svg>
        {% endif %}
      </span>
      <div>
        <strong>{{ nome_empresa }}</strong><br>
        <small style="color:#777">Meu perfil</small>
      </div>
    </div>

    <div class="pm-group-title">Minha conta</div>
    <a href="{{ url_for('editar_empresa') }}" class="pm-item" role="menuitem" title="Editar cadastro">
      <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
      <span>Editar cadastro</span>
    </a>
    <a href="{{ url_for('performance_acesso') }}" class="pm-item" role="menuitem" title="Ver performance de acesso">
      <svg viewBox="0 0 24 24"><path d="M3 3v18h18"></path><path d="M7 13l3 3 7-7"></path></svg>
      <span>Performance de acesso</span>
    </a>

    <div class="pm-group-title">Assinatura</div>
    {% if assinatura_ativa %}
      <a href="{{ url_for('checkout', plano=empresa.plano or 'mensal') }}" class="pm-item" role="menuitem" title="Gerenciar pagamento">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M3 10h18"></path></svg>
        <span>Minha assinatura (ativa)</span>
      </a>
    {% else %}
      <a href="{{ url_for('checkout', plano='mensal') }}" class="pm-item" role="menuitem" title="Pagar assinatura">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M3 10h18"></path></svg>
        <span>Assinatura pendente (pagar)</span>
      </a>
    {% endif %}

    <div class="pm-sep"></div>

    <a href="{{ url_for('fale_conosco') }}" class="pm-item" role="menuitem" title="Falar com o suporte">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path></svg>
      <span>Suporte AcheTece</span>
    </a>
    <a href="{{ url_for('logout') }}" class="pm-item" role="menuitem" title="Sair">
      <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><path d="M16 17l5-5-5-5"></path><path d="M21 12H9"></path></svg>
      <span>Sair</span>
    </a>
  </nav>

  <!-- form oculto para upload de foto -->
  <form id="fotoForm" action="{{ url_for('perfil_foto_upload') }}" method="POST" enctype="multipart/form-data" class="sr-only">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <input type="file" id="fotoInputLib"  name="foto" accept="image/*">
    <input type="file" id="fotoInputCam"  name="foto" accept="image/*" capture="environment">
    <input type="file" id="fotoInputFile" name="foto" accept="image/*,.jpg,.jpeg,.png,.webp,.gif">
  </form>
</header>

<div class="container">
  <h1 class="titulo">Painel da Malharia</h1>
  <p style="text-align:center;">Bem-vindo(a), <strong>{{ nome_empresa }}</strong>!</p>

  <!-- ===== HERO ===== -->
  <div class="hero-card">
    <div>
      <div class="hero-ident">
        <div class="hero-avatar" aria-label="Foto do perfil" title="Clique no lápis para alterar a foto">
          {% if avatar_url %}
            <img
              class="js-avatar"
              src="{{ avatar_url }}"
              alt="Foto do perfil"
              decoding="async"
              referrerpolicy="no-referrer"
              draggable="false">
          {% else %}
            <img
              class="js-avatar"
              src=""
              alt="Foto do perfil"
              style="display:none"
              decoding="async"
              referrerpolicy="no-referrer"
              draggable="false">
            <svg class="avatar-ph" viewBox="0 0 24 24">
              <circle cx="12" cy="8" r="4"></circle>
              <path d="M4 20c0-4 4-7 8-7s8 3 8 7"></path>
            </svg>
          {% endif %}

          <button class="edit-pencil" id="pencilToggle" type="button" title="Alterar foto do perfil" aria-label="Alterar foto do perfil">
            <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
          </button>

          <div id="photoMenu" class="photo-menu" aria-label="Opções da foto" role="menu">
            <button type="button" class="photo-item" data-act="gallery">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="8.5" cy="11.5" r="2.5"></circle><path d="M21 15l-5-5-4 4-2-2-5 5"></path></svg>
              <span>Fototeca</span>
            </button>
            <button type="button" class="photo-item" data-act="camera">
              <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"></rect><path d="M8 7l2-3h4l2 3"></path><circle cx="12" cy="14" r="3.5"></circle></svg>
              <span>Tirar foto</span>
            </button>
            <button type="button" class="photo-item" data-act="file">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path></svg>
              <span>Escolher arquivo</span>
            </button>
          </div>
        </div>

        <div class="hero-info" style="min-width:0;">
          <div class="hero-nome">{{ nome_empresa }}</div>

          <div class="hero-chips">
            {% if _assin_ativa %}
              <span class="chip" title="Assinatura ativa"><span class="dot dot-success"></span>Assinatura ativa</span>
          
              {% if vencimento_proximo %}
                <span class="chip chip-venc"
                      title="Se cair em fim de semana ou feriado nacional, o vencimento vai para o próximo dia útil.">
                  <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="3" y="4" width="18" height="16" rx="2"></rect>
                    <path d="M8 2v4M16 2v4M3 10h18"></path>
                  </svg>
                  <span class="chip-text">Vence em {{ vencimento_proximo.strftime('%d/%m/%Y') }}</span>
                </span>
              {% endif %}
          
            {% else %}
              <a class="chip" href="{{ url_for('checkout', plano='mensal') }}" title="Pagar assinatura">
                <span class="dot dot-warn"></span>Assinatura pendente
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <aside class="perf-mini">
      <div class="perf-mini-title">Performance de acesso</div>
      <a href="{{ url_for('performance_acesso') }}" class="perf-mini-link">Ver detalhes</a>
    </aside>
  </div>
  <!-- ===== /HERO ===== -->

  <div class="sec-title">
    <h2>Teares Cadastrados:</h2>
    <a href="{{ url_for('teares_form') }}" class="btn-roxo">+ Cadastrar Tear</a>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Tipo</th>
          <th>Galga/Finura</th>
          <th>Diâmetro</th>
          <th>Alimentadores</th>
          <th>Pistas (cil)</th>
          <th>Pistas (disco)</th>
          <th>Elastano</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% set _vaz = '—' %}
        {% if lista_teares and lista_teares|length %}
          {% for tear in lista_teares %}
          <tr>
            <td>{{ tear.marca or _vaz }}</td>
            <td>{{ tear.modelo or _vaz }}</td>
            <td>{{ tear.tipo or _vaz }}</td>
            <td>{{ tear.finura or tear.galga or _vaz }}</td>
            <td>{{ tear.diametro or _vaz }}</td>
            <td>{{ tear.alimentadores or _vaz }}</td>
            <td>{{ tear.pistas_cilindro or _vaz }}</td>
            <td>{{ tear.pistas_disco or _vaz }}</td>
            <td>
              {% set raw = tear.elastano if (tear.elastano is not none) else tear.kit_elastano %}
              {% if raw is boolean %}
                {{ 'Sim' if raw else 'Não' }}
              {% else %}
                {% set s = (raw|string).strip().lower() %}
                {% if s in ['sim','s','true','t','on','1','com','tem','yes','y'] %}Sim
                {% elif s in ['não','nao','n','false','f','off','0','sem','no'] %}Não
                {% else %}{{ _vaz }}{% endif %}
              {% endif %}
            </td>
            <td>
              <div class="acoes-wrap">
                <a href="{{ url_for('editar_tear', id=tear.id) }}" class="icon-btn edit" title="Editar tear" aria-label="Editar">
                  <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                  <span class="sr-only">Editar</span>
                </a>
                <form method="POST"
                      action="{{ url_for('excluir_tear', id=tear.id) }}"
                      onsubmit="return confirm('Confirma excluir este tear? Essa ação é irreversível.');"
                      style="display:inline">
                  <input type="hidden" name="next" value="{{ url_for('painel_malharia') }}">
                  <button type="submit" class="icon-btn danger" title="Excluir tear" aria-label="Excluir">
                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
                    <span class="sr-only">Excluir</span>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="10">Nenhum tear cadastrado ainda.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="teares-cards">
    {% if lista_teares|length %}
      {% for tear in lista_teares %}
        <div class="tear-card">
          <div class="tear-hd">
            <div class="tear-title">{{ tear.marca or '-' }} — {{ tear.modelo or '-' }}</div>
            <div class="tear-actions">
              <a href="{{ url_for('editar_tear', id=tear.id) }}" class="icon-btn edit" title="Editar">
                <svg viewBox="0 0 24 24"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </a>
              <form method="POST"
                    action="{{ url_for('excluir_tear', id=tear.id) }}"
                    onsubmit="return confirm('Confirma excluir este tear? Essa ação é irreversível.');">
                <input type="hidden" name="next" value="{{ url_for('painel_malharia') }}">
                <button type="submit" class="icon-btn danger" title="Excluir">
                  <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>
                </button>
              </form>
            </div>
          </div>

          <div class="tear-body">
            <div class="tear-item it-tipo"><span>Tipo</span><strong>{{ tear.tipo or '-' }}</strong></div>
            <div class="tear-item it-diametro"><span>Diâmetro</span><strong>{{ tear.diametro if tear.diametro is not none else '-' }}</strong></div>
            <div class="tear-item it-finura"><span>Finura</span><strong>{{ tear.finura if tear.finura is not none else '-' }}</strong></div>
            <div class="tear-item it-alims"><span>Alimentadores</span><strong>{{ tear.alimentadores if tear.alimentadores is not none else '-' }}</strong></div>
            <div class="tear-item it-elastano"><span>Elastano</span><strong>{{ 'Sim' if (tear.elastano or tear.kit_elastano) else 'Não' }}</strong></div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="tear-card">Nenhum tear cadastrado ainda.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Webcam (desktop) -->
<div id="camOverlay" class="cam-overlay" aria-hidden="true">
  <div class="cam-modal" role="dialog" aria-modal="true" aria-label="Capturar foto">
    <video id="camVideo" class="cam-video" autoplay playsinline></video>
    <canvas id="camCanvas" class="sr-only"></canvas>
    <div class="cam-actions">
      <button type="button" class="btn" id="camCancel">Cancelar</button>
      <button type="button" class="btn btn-primary" id="camShot">Capturar</button>
    </div>
  </div>
</div>

<!-- Overlay transparente global -->
<div id="photoOverlay" class="photo-overlay" hidden></div>

<script>
  (function(){
    // menu perfil
    const toggle = document.getElementById('profileToggle');
    const menu   = document.getElementById('profileMenu');
    function closeMenu(){ menu.classList.remove('open'); toggle?.setAttribute('aria-expanded','false'); }
    function openMenu(){  menu.classList.add('open');    toggle?.setAttribute('aria-expanded','true'); }
    function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }
    toggle?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });

    // notificações
    const nbtn = document.getElementById('notifToggle');
    const npanel = document.getElementById('notifPanel');
    function closeNotif(){ npanel.classList.remove('open'); }
    function toggleNotif(e){ e.stopPropagation(); npanel.classList.toggle('open'); }
    nbtn?.addEventListener('click', toggleNotif);

    // fechar quando clicar fora / ESC
    document.addEventListener('click', ()=>{ closeMenu(); closeNotif(); closePhotoMenu(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); closeNotif(); closePhotoMenu(); closeCam(); }});
    menu?.addEventListener('click', (e)=> e.stopPropagation());
    npanel?.addEventListener('click', (e)=> e.stopPropagation());

    // ===== Upload de foto - opções =====
    const fotoForm  = document.getElementById('fotoForm');
    const inLib     = document.getElementById('fotoInputLib');
    const inCam     = document.getElementById('fotoInputCam');
    const inFile    = document.getElementById('fotoInputFile');
    const pencil    = document.getElementById('pencilToggle');
    const photoMenu = document.getElementById('photoMenu');
    const overlay   = document.getElementById('photoOverlay');

    function openPhotoMenu(){ photoMenu.classList.add('open'); if (overlay) overlay.hidden = false; }
    function closePhotoMenu(){ photoMenu.classList.remove('open'); if (overlay) overlay.hidden = true; }

    overlay?.addEventListener('click', (e)=>{ e.stopPropagation(); closePhotoMenu(); });

    pencil?.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      photoMenu.classList.contains('open') ? closePhotoMenu() : openPhotoMenu();
    });
    photoMenu?.addEventListener('click', (e)=>{ e.stopPropagation(); });

    function triggerInput(inputEl){ try { inputEl.click(); } catch(e) { setTimeout(()=>inputEl.click(), 0); } }

    photoMenu?.querySelectorAll('.photo-item').forEach(btn=>{
      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        const act = btn.getAttribute('data-act');
        if (act === 'gallery'){ inLib.value = ""; triggerInput(inLib); }
        else if (act === 'file'){ inFile.value = ""; triggerInput(inFile); }
        else if (act === 'camera'){
          const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
          if (isMobile){ inCam.value = ""; triggerInput(inCam); }
          else { openCam(); }
        }
      }, {passive:false});
    });

    // ===== Webcam (desktop) =====
    const camOverlay = document.getElementById('camOverlay');
    const camVideo   = document.getElementById('camVideo');
    const camCanvas  = document.getElementById('camCanvas');
    const camCancel  = document.getElementById('camCancel');
    const camShot    = document.getElementById('camShot');
    let camStream = null;

    async function openCam(){
      try{
        camStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        camVideo.srcObject = camStream;
        camOverlay.classList.add('open');
        if (overlay) overlay.hidden = false;
      }catch(err){
        alert('Não foi possível acessar a câmera. Se preferir, use "Escolher arquivo".');
        if (overlay) overlay.hidden = true;
      }
    }
    function closeCam(){
      camOverlay.classList.remove('open');
      if (overlay) overlay.hidden = true;
      if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
    }
    camCancel?.addEventListener('click', closeCam);

    camShot?.addEventListener('click', async ()=>{
      if (!camVideo.videoWidth){ return; }
      const w = camVideo.videoWidth, h = camVideo.videoHeight;
      camCanvas.width = w; camCanvas.height = h;
      const ctx = camCanvas.getContext('2d');
      ctx.drawImage(camVideo, 0, 0, w, h);
      camCanvas.toBlob(async (blob)=>{
        if (!blob) return;
        try{
          const dataURL = camCanvas.toDataURL('image/jpeg', 0.92);
          if (dataURL){
            // preview imediato na tela atual
            document.querySelectorAll('img.js-avatar').forEach(img => {
              img.src = dataURL;
              img.style.display = '';
            });
          }
        }catch(e){}
        const fd = new FormData();
        const csrf = fotoForm.querySelector('input[name="csrf_token"]')?.value;
        if (csrf) fd.append('csrf_token', csrf);
        fd.append('foto', blob, 'camera.jpg');
        try{
          const resp = await fetch(fotoForm.action, { method:'POST', body: fd, credentials:'same-origin' });
          if (resp.ok){ closeCam(); location.reload(); }
          else { closeCam(); alert('Falha ao enviar a foto.'); }
        }catch(e){ closeCam(); alert('Erro ao enviar a foto.'); }
      }, 'image/jpeg', 0.92);
    });

    // ===== AVATAR PREVIEW + CACHE-BUSTER =====
    function addBust(url, ts){
      if (!url) return url;
      try{
        const u = new URL(url, window.location.origin);
        u.searchParams.set('v', ts);
        return u.toString();
      }catch(e){
        return url + (url.includes('?') ? '&' : '?') + 'v=' + ts;
      }
    }
    function setAllAvatars(url){
      document.querySelectorAll('img.js-avatar').forEach(img=>{
        img.src = url; img.style.display = '';
      });
      // esconder apenas o placeholder do avatar (classe .avatar-ph)
      document.querySelectorAll('.hero-avatar > svg.avatar-ph').forEach(svg=>{ svg.style.display = 'none'; });
    }
    function previewAndSubmit(inputEl){
      closePhotoMenu();
      if (!(inputEl?.files && inputEl.files.length)) return;
      const file = inputEl.files[0];
      try{
        const reader = new FileReader();
        reader.onload = function(){
          const dataUrl = reader.result;
          if (dataUrl){
            // preview imediato na tela atual, sem gravar em localStorage
            setAllAvatars(dataUrl);
          }
          setTimeout(() => {
            if (fotoForm?.requestSubmit) fotoForm.requestSubmit(); else fotoForm?.submit();
          }, 80);
        };
        reader.readAsDataURL(file);
      }catch(err){
        if (fotoForm?.requestSubmit) fotoForm.requestSubmit(); else fotoForm?.submit();
      }
    }
    inLib?.addEventListener('change', function(){ previewAndSubmit(this); });
    inFile?.addEventListener('change', function(){ previewAndSubmit(this); });
    inCam?.addEventListener('change', function(){ previewAndSubmit(this); });

    // ===== Inicialização + reforço do avatar =====
    const serverAvatarUrl = {{ (avatar_url or '') | tojson }};

    function ensureServerAvatar(){
      if (!serverAvatarUrl) return;

      // usa sempre a foto oficial vinda do servidor
      document.querySelectorAll('img.js-avatar').forEach(img => {
        // se estiver sem src ou com algo vazio/estranho, força a URL correta
        if (!img.src || img.src === window.location.href || img.src === window.location.origin + '/' || img.src === '' || img.src === 'about:blank') {
          img.src = serverAvatarUrl;
        }
        img.style.display = '';
      });

      // garante que o placeholder some
      document.querySelectorAll('.hero-avatar > svg.avatar-ph').forEach(svg => {
        svg.style.display = 'none';
      });
    }

    // chama imediatamente
    ensureServerAvatar();
    // reforça depois de alguns segundos, caso outro script tente limpar
    setTimeout(ensureServerAvatar, 1500);
    setTimeout(ensureServerAvatar, 4000);

    // ===== FIX definitivo do avatar: sempre usar foto_url do servidor =====
    const fotoUrlFix = {{ (foto_url or '') | tojson }};

    function fixAvatarFromServer(){
      if (!fotoUrlFix) return;

      // Força todas as imagens de avatar a usar SEMPRE a foto_url vinda do backend
      document.querySelectorAll('img.js-avatar').forEach(img => {
        // Se estiver sem src ou com algo estranho, aplica a foto correta
        if (
          !img.src ||
          img.src === window.location.href ||
          img.src === window.location.origin + '/' ||
          img.src === 'about:blank'
        ){
          img.src = fotoUrlFix;
        }
        img.style.display = '';
      });

      // Some com o placeholder se a foto oficial existir
      if (fotoUrlFix){
        document.querySelectorAll('.hero-avatar > svg.avatar-ph').forEach(svg => {
          svg.style.display = 'none';
        });
      }
    }

    // Chama logo que o script carrega…
    fixAvatarFromServer();
    // … e reforça depois (caso algum outro script tente sobrescrever)
    setTimeout(fixAvatarFromServer, 1500);
    setTimeout(fixAvatarFromServer, 4000);
  
    // Fechamentos globais
    document.addEventListener('click', ()=>{ closeMenu(); closeNotif(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); closeNotif(); closePhotoMenu(); closeCam(); }});
  })();
</script>
</body>
</html>
