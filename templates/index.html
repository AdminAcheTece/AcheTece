<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>AcheTece - Portal de Malharias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Ícone da aba (favicon) -->
  <link rel="icon" type="image/x-icon" href="/static/favicon_final.ico">
  <link rel="icon" type="image/png" href="/static/favicon_final.png">

  <!-- CSS principal -->
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
  :root{
    /* NOVA PALETA (inspirada no exemplo Falconi) */
    --olive:#7B7424;
    --olive-600:#5E581C;      /* hover/ativo */
    --olive-dark:#434326;     /* textos/acento escuro */
    --olive-50:#F1F2E8;       /* fundo clarinho “roxinho” antigo */
    --olive-100:#E6E7DE;      /* cabeçalhos/hover suave */
    --line-olive:#BFBFA8;     /* bordas suaves */

    --bg-100:#F5F5F4;
    --bg-150:#EAEAE8;         /* faixa cinza do miolo */
    --bg-200:#DFDFD9;

    /* MAPA DE COMPATIBILIDADE (sem quebrar seu HTML/CSS) */
    --roxo:var(--olive);
    --roxo-hover:var(--olive-600);
    --preto:#000;

    /* trocamos o “laranja” para a nova primária p/ manter CTAs */
    --laranja:var(--olive);
    --laranja-hover:var(--olive-600);

    /* “roxinho” vira oliva bem claro */
    --roxinho:var(--olive-50);
    --cinza-150:var(--bg-150);

    /* LIME (hover neon) */
    --lime:#B6F34D;
    --lime-700:#A2E532;
  }

  html, body { max-width:100%; overflow-x:hidden; }
  *, *::before, *::after { box-sizing:border-box; }

  .mobile-only{ display:none; }
  .desktop-only{ display:block; }
  @media (max-width:820px){
    .mobile-only{ display:block; }
    .desktop-only{ display:none; }
  }

  /* ===== HEADER (AJUSTADO) ===== */
  .navbar{
    background:#000;
    border-radius:9999px;
    width:calc(100% - 220px);      /* MAIS LARGA no desktop (mais próxima das laterais) */
    max-width:none;               /* remove limite de 1280px */
    margin:14px auto;
    padding:12px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    overflow:visible;
    box-shadow:0 10px 28px rgba(0,0,0,.18);
  }

  .header-left,.header-right{display:flex;align-items:center;}
  .hdr-actions{display:flex;align-items:center;gap:12px;}

  /* Logo (DESKTOP) - reduz para caber bem dentro da faixa */
  .navbar .logo img{
    height:60px !important;    /* ajuste aqui: 24 / 26 / 28 / 30 */
    width:auto !important;
    display:block;
    object-fit:contain;
  }

  /* Botão Conta Malharia (BLINDADO contra style.css) */
  .navbar .btn-perfil{
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    height:44px !important;
    padding:0 22px !important;
    border-radius:9999px !important;
    font-weight:800 !important;
    text-decoration:none !important;     /* remove underline */
    background:#fff !important;          /* fundo branco */
    color:#000 !important;               /* texto preto */
    border:0 !important;
    box-shadow:none !important;
    line-height:1 !important;
    white-space:nowrap !important;
    cursor:pointer;
    transition: background-color .15s ease, color .15s ease, transform .15s ease;
  }

  /* Hover mantendo padrão atual (lime) */
  .navbar .btn-perfil:hover{
    background:var(--lime) !important;
    color:#111 !important;
    transform:translateY(-1px);
  }
  .navbar .btn-perfil:active{
    background:var(--lime-700) !important;
    color:#111 !important;
    transform:translateY(0);
  }
  .navbar .btn-perfil:focus-visible{
    outline:2px solid var(--lime);
    outline-offset:2px;
  }

  /* Mobile: logo 50% menor + header mais compacto */
  @media (max-width:900px){
    .navbar{
      border-radius:34px;
      width:calc(100% - 20px);
      margin:10px auto;
      padding:10px 12px;
    }
    .navbar .logo img{
      height:60px !important;
    }
    .navbar .btn-perfil{
      height:36px !important;
      padding:0 14px !important;
      font-size:13px !important;
    }
  }

  /* ===== PROMO ===== */
  .promo-bar{
    background:#000;color:#fff;display:flex;align-items:center;justify-content:center;gap:12px;
    padding:6px 10px;font-size:14px;line-height:1.2;
  }
  .promo-cta{
    display:inline-block;background:var(--roxo);color:#fff;text-decoration:none;padding:6px 10px;
    border-radius:8px;font-weight:600;white-space:nowrap;transition:.2s;
  }
  .promo-cta:hover{background:var(--roxo-hover);transform:translateY(-1px);}
  @media (max-width:600px){.promo-bar{flex-wrap:wrap;row-gap:6px}}

  /* ===== FAIXA CINZA DO MIOLO ===== */
  .faixa-cinza{ background:var(--cinza-150); padding:16px 0 48px; }

  /* Garante cards e campos internos SEM cinza */
  .localizacao-card, .results-card, .filters-panel, .card-tear{ background:#fff !important; }

  /* ===== CTA + FOOTER ===== */
  .cta-bar{background:#000;color:#fff;padding:20px 16px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;border-top:1px solid rgba(255,255,255,0.06);margin-top:0;justify-content:flex-start;}
  .cta-text h3{margin:0 0 4px 0;font-size:18px;font-weight:700;}
  .cta-text p{margin:0;font-size:15px;opacity:.9;}
  .cta-btn{display:inline-block;background:#fff;color:#000;text-decoration:none;padding:10px 22px;border-radius:9999px;font-weight:700;}
  .cta-btn:hover{background:#f2f2f5;transform:translateY(-1px);}
  .site-footer{background:#fff;color:#211a2a;border-top:1px solid #eee;padding:18px 16px 28px;}
  .footer-inner{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:auto 1fr;gap:20px 28px;align-items:start;}
  .footer-brand img{height:44px;width:auto;display:block;}
  .footer-cols{display:grid;grid-template-columns:repeat(2,minmax(180px,240px));gap:12px 28px;}
  .footer-col h4{margin:0 0 8px 0;font-size:14px;font-weight:700;color:#251c33;}
  .footer-col ul{list-style:none;margin:0;padding:0;}
  .footer-col li+li{margin-top:6px;}
  .footer-col a{color:#2a2535;text-decoration:none;font-size:14px;}
  .footer-col a:hover{text-decoration:underline;}

  /* ===== LAYOUT ===== */
  .page-outer{
    max-width:1280px;
    margin:0 auto;
    padding:0 16px;
  }

  /* Container */
  .page-hint{
    margin:10px 0 6px;
    padding:6px 0;
    text-align:center;
    color:#000;
  }

  /* Título principal */
  #hint-teares{
    font-size:60px !important;  /* desktop */
    line-height:1.15;
  }

  @media (max-width:600px){
    #hint-teares{
      font-size:25px !important; /* mobile */
      margin-top:8px;
    }
  }

  /* Subtítulo */
  .page-subhint{
    margin-top:12px;
    font-size:20px;
    line-height:1.35;
    color:#2a2535;
    opacity:.86;
  }

  /* Bullets */
  .page-trust{
    margin-top:14px;
    margin-bottom:40px;   /* AQUI você ajusta o espaço abaixo dos bullets */
    display:flex;
    align-items:center;
    justify-content:center;
    gap:18px;
    flex-wrap:wrap;
    font-size:16px;
    color:#2a2535;
    opacity:.92;
  }
  .page-trust span{
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:600;
  }

  @media (max-width:600px){
    .page-subhint{ font-size:16px; }
    .page-trust{ font-size:14px; }
  }

  /* Botões topo (mobile) */
  .filters-toggle-bar{display:none; gap:8px; margin:8px 0 6px;}
  .btn-pill{
    display:inline-flex;align-items:center;justify-content:center;
    height:40px;padding:0 16px;border-radius:9999px;font-weight:700;cursor:pointer;border:0;
    box-shadow:0 2px 8px rgba(0,0,0,.06); text-decoration:none; font-size:15px;
  }
  .btn-open-filters{ background:var(--roxo); color:#fff; }
  .btn-open-filters:hover{ background:var(--roxo-hover); }
  .btn-new-search{ background:var(--laranja); color:#fff; }
  .btn-new-search:hover{ background:var(--laranja-hover); }
  .ico-funil{ width:18px;height:18px; margin-right:8px; }
  @media (max-width:1024px){ .filters-toggle-bar{display:flex;} }

  .search-layout{display:grid;grid-template-columns:300px 1fr;gap:24px;align-items:start;margin:10px 0 0;}
  @media (max-width:1024px){ .search-layout{grid-template-columns:1fr} }

  /* Filtros (esquerda) */
  .filters-panel{border:1px solid #eee;border-radius:14px;padding:16px;background:#fff;position:sticky;top:56px;max-height:calc(100vh - 72px);overflow:auto;z-index:10;}
  .filters-title{margin:0 0 12px;font-size:18px;font-weight:700;}
  .filters-panel .filter-field{margin-bottom:22px;}
  .filters-panel .filter-field label{display:block;font-size:14px;margin-bottom:8px;color:#2a2535;font-weight:700;}
  .filter-field select,.filter-field input{width:100%;height:40px;padding:8px 10px;border:1px solid #ccc;border-radius:10px;background:#fff;color:#333;}

  /* Gaveta mobile */
  .filters-close{display:none;} .filters-backdrop{display:none;}
  @media (max-width:1024px){
    .filters-panel{position:fixed;left:0;top:0;bottom:0;width:min(90%,360px);max-width:90vw;border-radius:0;padding:16px;transform:translateX(-110%);transition:transform .2s ease;z-index:1001;max-height:none;overflow:auto}
    .filters-panel.is-open{transform:translateX(0)}
    body.filters-open{overflow:hidden}
    .filters-close{display:block;position:absolute;top:6px;right:10px;background:transparent;border:0;font-size:28px;line-height:1;cursor:pointer;}
    .filters-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:1000;display:none;}
    body.filters-open .filters-backdrop{display:block;}
    .filters-title{padding-right:30px}
  }

  /* Direita */
  .right-col{display:flex;flex-direction:column;gap:16px;}
  .localizacao-card{border:1px solid #eee;border-radius:12px;padding:16px 16px 8px;width:100%;max-width:100%;}
  .localizacao-card h2{margin:0 0 10px 0;font-size:18px;font-weight:700;}
  .localizacao-card .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .localizacao-card label{display:block;font-size:14px;margin:8px 0 6px;color:#444;font-weight:700;}
  .localizacao-card select{width:100%;height:40px;padding:8px 10px;border:1px solid #ccc;border-radius:10px;background:#fff;color:#333;}
  @media (max-width:620px){.localizacao-card .row{grid-template-columns:1fr}}

  /* ===== RESULTADOS ===== */
  .results-card{border:1px solid #eee;border-radius:12px;padding:12px;max-width:1140px;margin:0 auto;}
  .results-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 4px 6px;}
  .results-head h3{margin:0;font-size:16px;font-weight:700;}
  .results-count{font-size:13px;color:#555;}

  /* Breadcrumb */
  .crumbs{display:flex;align-items:center;gap:6px;padding:4px 4px 10px 4px;font-size:13px;color:#555;}
  .crumbs a{color:var(--roxo);text-decoration:none;}
  .crumbs a:hover{text-decoration:underline;}
  .crumbs .sep{opacity:.5;}
  .crumbs .current{color:#222;font-weight:600;}

  /* Tabela (desktop) */
  .table-wrap{overflow-x:auto;}
  .teares-table{width:100%;border-collapse:collapse;}
  .teares-table th,.teares-table td{padding:10px;border-bottom:1px solid #f1f1f1;text-align:left;font-size:14px;vertical-align:middle;}
  .teares-table th{background:#fafafa;font-weight:700;}
  .cell-empresa{font-weight:700;}
  @media (min-width:821px){
    .teares-table th:nth-child(n+2), .teares-table td:nth-child(n+2){ text-align:center; }
  }

  /* WhatsApp (ícone apenas) — tamanhos */
  .wa-link{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:50%;border:1px solid #ddd;text-decoration:none;background:#fff;flex-shrink:0;}
  .wa-link:hover{background:#f7f7f7}
  .wa-icon{width:26px;height:26px;display:block}

  /* Botão "Ver empresa" (pill) */
  .btn-view{
    display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 12px;border-radius:9999px;
    border:1px solid #ddd;background:#fff;color:#2a2535;text-decoration:none;font-weight:700;font-size:13px;
  }
  .btn-view:hover{background:var(--bg-100);border-color:var(--line-olive)}
  .ic-building{width:18px;height:18px;color:var(--roxo);display:block}

  /* ===== MOBILE (cards) ===== */
  .cards-grid{display:grid;grid-template-columns:1fr;gap:12px;}
  .card-tear{ border:1px solid #eee;border-radius:16px;padding:12px; }
  @media (max-width:820px){ .card-tear{ border-color:#ccc; } }
  .card-title{font-weight:800;font-size:1.02rem;margin:0 0 6px;}

  /* Novo bloco compacto de infos do card */
  .card-info2{display:flex;flex-direction:column;gap:4px;font-size:12.5px;line-height:1.25;color:#333;}
  .card-info2 .row{display:flex;gap:10px;align-items:baseline;flex-wrap:nowrap;}
  .card-info2 .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .card-info2 .lbl{color:#666;margin-right:4px;}
  .card-info2 .val{font-weight:800;color:#111;}

  /* “Roxinho” da empresa agora oliva bem claro */
  .card-empresa{
    margin-top:10px;padding:8px 10px;border-radius:12px;
    background:var(--roxinho); border:1px solid var(--line-olive);
  }
  .empresa-top{display:flex;align-items:center;justify-content:space-between;gap:8px;min-width:0;}
  .empresa-top .nome{font-weight:800;font-size:0.98rem;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .empresa-actions{display:flex;align-items:center;gap:6px;flex-shrink:0;}
  .empresa-actions .btn-view{height:32px;padding:0 10px;font-size:12px;}
  .empresa-actions .wa-link{width:32px;height:32px;}
  .empresa-bottom{margin-top:4px;display:flex;align-items:center;gap:6px;font-size:12px;line-height:1;color:#616161;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .empresa-bottom .pin{width:14px;height:14px;flex:0 0 14px;color:#6a6a6a;}

  /* Texto curto do botão no mobile */
  .btn-view .lbl-short{ display:none; }
  @media (max-width:480px){
    .empresa-actions .btn-view{height:30px;padding:0 8px;font-size:12px;}
    .empresa-actions .wa-link{width:30px;height:30px;}
    .btn-view .lbl-full{ display:none; }
    .btn-view .lbl-short{ display:inline; }
  }

  /* Mostrar cards só no mobile; tabela só no desktop */
  @media (max-width:820px){ .table-wrap{display:none;} }
  @media (min-width:821px){ .mobile-only{display:none;} }

  /* Paginação */
  .pager{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:14px 4px 6px;flex-wrap:wrap}
  .pager .group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .pager .btn-page{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;padding:0 10px;border:1px solid #ddd;border-radius:10px;background:#fff;color:#333;text-decoration:none;font-size:14px;}
  .pager .btn-page:hover{background:#f8f8f8}
  .pager .btn-page[aria-disabled="true"]{opacity:.5;pointer-events:none}
  .pager .info{font-size:13px;color:#666}
  .pager select{height:36px;border:1px solid #ddd;border-radius:10px;padding:0 10px;background:#fff}

  /* ===== Desktop: zebra + cabeçalho mais visível na tabela (tons oliva) ===== */
  @media (min-width:821px){
    .teares-table thead th{
      background: var(--olive) !important;
      color: #fff !important;
      border-bottom: 1px solid var(--olive-600) !important;
    }
    .teares-table tbody tr:nth-child(odd){  background:#FFFFFF; }
    .teares-table tbody tr:nth-child(even){ background:var(--olive-50); }
    .teares-table tbody tr:hover{ background:var(--olive-100); }
  }

  /* Tipografia um pouco menor em telas bem estreitas */
  @media (max-width:390px){
    .card-title{font-size:1rem;}
    .card-info2{font-size:12px;}
    .empresa-top .nome{font-size:.95rem;}
  }
</style>
</head>
<body>

  <!-- Cabeçalho -->
  <header class="navbar">
    <div class="header-left">
      <div class="logo">
        <a href="{{ url_for('index') }}" aria-label="Página inicial">
          <img
            src="{{ url_for('static', filename='Logo_Branco_AcheTece_sem_fundo.png') }}"
            alt="Logo AcheTece"
            decoding="async"
            fetchpriority="high"
          >
        </a>
      </div>
    </div>
    <div class="header-right">
      <div class="hdr-actions">
        <a href="/login" class="btn-perfil" aria-label="Acessar sua conta da malharia" title="Acessar sua conta da malharia">
          <span>Conta Malharia</span>
        </a>
      </div>
    </div>
  </header>

  <!-- ===== Miolo em CINZA ===== -->
  <div class="faixa-cinza">
    <div class="page-outer">

      <!-- Mensagem orientativa -->
      <div class="page-hint" role="note">
        <div id="hint-teares">
          Encontre o <strong>tear e a malharia ideal</strong> para sua produção, use os filtros abaixo.
        </div>

        <div class="page-subhint">
          Fornecedores e teares com informações estruturadas — contato direto e decisão mais rápida.
        </div>

        <div class="page-trust">
          <span>✓ Dados organizados</span>
          <span>✓ Contato direto</span>
          <span>✓ Filtros técnicos</span>
        </div>
      </div>

      <!-- Botões topo (mobile) -->
      <div class="filters-toggle-bar">
        <button class="btn-pill btn-open-filters" id="openFiltersBtn" type="button" aria-controls="filtersPanel" aria-expanded="false">
          <svg class="ico-funil" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 5h18M6 11h12M10 17h4"/>
          </svg>
          Filtros
        </button>
        <a class="btn-pill btn-new-search" href="{{ url_for('index') }}">Nova busca</a>
      </div>

      <!-- ===== FORM ÚNICO (GET) ===== -->
      <form id="filtrosForm" method="GET" action="{{ url_for('index') }}" class="search-layout">

        <!-- Backdrop painel filtros mobile -->
        <div class="filters-backdrop" id="filtersBackdrop" aria-hidden="true"></div>

        <!-- COLUNA ESQUERDA: FILTROS (sem Estado/Cidade) -->
        <aside class="filters-panel" id="filtersPanel" aria-label="Filtros de teares">
          <button class="filters-close" id="closeFiltersBtn" type="button" aria-label="Fechar filtros">×</button>
          <h2 class="filters-title">Filtrar teares</h2>

          {% for campo, opcoes_campo in opcoes.items() %}
            {% set c = campo|lower %}
            {% if c not in ['estado','cidade'] %}
              {% if c == 'galga' %}
                <div class="filter-field">
                  <label for="{{ campo }}">Galga/Finura</label>
                  <input type="number" id="{{ campo }}" name="{{ campo }}" class="auto-apply" inputmode="numeric" step="1" min="1" placeholder="Digite a galga (ex.: 28)" value="{{ filtros[campo] or '' }}" autocomplete="off">
                </div>
              {% elif c in ['diâmetro','diametro'] %}
                <div class="filter-field">
                  <label for="{{ campo }}">Diâmetro</label>
                  <input type="number" id="{{ campo }}" name="{{ campo }}" class="auto-apply" inputmode="decimal" step="0.1" min="1" placeholder="Digite o diâmetro (ex.: 30)" value="{{ filtros[campo] or '' }}" autocomplete="off">
                </div>
              {% else %}
                <div class="filter-field">
                  <label for="{{ campo }}">{{ campo|capitalize }}</label>
                  <select name="{{ campo }}" id="{{ campo }}" class="auto-apply">
                    <option value="">-- Todos --</option>
                    {% for opcao in opcoes_campo %}
                      <option value="{{ opcao }}" {% if filtros[campo] == opcao %}selected{% endif %}>{{ opcao }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}

          <!-- Hidden paginação -->
          <input type="hidden" name="pagina" id="pagina_hidden" value="{{ request.args.get('pagina','1') }}">
          <input type="hidden" name="pp" id="pp_hidden" value="{% if por_pagina is defined %}{{ por_pagina }}{% else %}{{ request.args.get('pp','20') }}{% endif %}">

          <div class="filter-actions">
            <a href="{{ url_for('index') }}" class="btn-limpar" title="Limpar filtros" style="display:inline-flex;align-items:center;gap:6px;background:var(--laranja);color:#fff;border-radius:9999px;height:36px;line-height:36px;padding:0 16px;text-decoration:none;font-weight:700;">Limpar</a>
          </div>
        </aside>

        <!-- COLUNA DIREITA: Localização + RESULTADOS -->
        <div class="right-col">
          <section class="localizacao-card" aria-labelledby="loc-title">
            {% set sel_uf = (filtros.get('estado') if filtros is defined else request.args.get('estado','')) %}
            {% set sel_cidade = (filtros.get('cidade') if filtros is defined else request.args.get('cidade','')) %}
            <h2 id="loc-title">Localização</h2>
            <div class="row">
              <div>
                <label for="estado">Estado</label>
                <select id="estado" name="estado" class="auto-apply">
                  <option value="">Selecione o estado</option>
                  {% set UF_LIST = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'] %}
                  {% for uf in UF_LIST %}
                    <option value="{{ uf }}" {% if sel_uf==uf %}selected{% endif %}>{{ uf }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="cidade">Cidade</label>
                <select id="cidade" name="cidade" class="auto-apply" data-selected="{{ sel_cidade }}" {% if not sel_uf %}disabled{% endif %}>
                  <option value="">{% if not sel_uf %}Selecione o estado primeiro{% else %}Todas{% endif %}</option>
                </select>
              </div>
            </div>
          </section>

          <!-- ===== RESULTADOS ===== -->
          <section class="results-card" aria-labelledby="res-title">
            <div class="results-head">
              <h3 id="res-title">Teares disponíveis</h3>
              {% if total is defined %}
                <div class="results-count">{{ total }} resultado(s)</div>
              {% endif %}
            </div>

            {% if resultados and resultados|length > 0 %}

              <!-- BREADCRUMB -->
              <div class="crumbs" aria-label="Navegação">
                {% set filtro_diam = filtros.get('diâmetro') or filtros.get('diametro') or '' %}
                <a href="{{ url_for('index',
                     pagina=1, pp=por_pagina,
                     tipo=filtros.get('tipo',''),
                     diametro=filtro_diam,
                     galga=filtros.get('galga',''),
                     estado='',
                     cidade='') }}">Brasil</a>
                {% if filtros.get('estado') %}
                  <span class="sep">›</span>
                  <a href="{{ url_for('index',
                       pagina=1, pp=por_pagina,
                       tipo=filtros.get('tipo',''),
                       diametro=filtro_diam,
                       galga=filtros.get('galga',''),
                       estado=filtros.get('estado',''),
                       cidade='') }}">{{ filtros.get('estado') }}</a>
                {% endif %}
                {% if filtros.get('cidade') %}
                  <span class="sep">›</span>
                  <span class="current">{{ filtros.get('cidade') }}</span>
                {% endif %}
              </div>

              <!-- CARDS (mobile) -->
              <div class="mobile-only">
                <div class="cards-grid">
                  {% for r in resultados %}
                    {% set tipo_txt = (r.tipo or '')|string|lower %}
                    {% set tipo_legivel = 'Mono' if tipo_txt[:4]=='mono' else ('Dupla' if tipo_txt[:5]=='dupla' else r.tipo) %}
                    <article class="card-tear">
                      <h3 class="card-title">Tear Malharia Circular</h3>

                      <!-- bloco compacto de infos -->
                      <div class="card-info2">
                        <div class="row">
                          <span class="lbl">Tipo:</span><span class="val">{{ tipo_legivel or '—' }}</span>
                        </div>
                        <div class="row two">
                          <div><span class="lbl">Diâmetro:</span><span class="val">{{ r.diametro or '—' }}</span></div>
                          <div><span class="lbl">Galga:</span><span class="val">{{ r.galga or '—' }}</span></div>
                        </div>
                        <div class="row two">
                          <div><span class="lbl">Alimentadores:</span><span class="val">{{ r.alimentadores or '—' }}</span></div>
                          <div>
                            <span class="lbl">Elastano:</span>
                            <span class="val">
                              {% set raw = r.elastano if (r is defined and (r.elastano is not none)) else r.kit_elastano %}
                              {% if raw is boolean %}
                                {{ 'Sim' if raw else 'Não' }}
                              {% else %}
                                {% set s = (raw|string).strip().lower() %}
                                {% if s in ['sim','s','true','t','on','1','com','tem','yes','y'] %}Sim
                                {% elif s in ['não','nao','n','false','f','off','0','sem','no'] %}Não
                                {% else %}—
                                {% endif %}
                              {% endif %}
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- bloco roxinho com empresa e cidade/UF -->
                      <div class="card-empresa">
                        <div class="empresa-top">
                          <div class="nome">{{ r.empresa }}</div>
                          <div class="empresa-actions">
                            <a class="btn-view js-view-company"
                               href="{{ url_for('empresa_perfil', empresa_id=r.empresa_id) }}"
                               title="Ver perfil da empresa"
                               aria-label="Ver perfil da empresa"
                               data-company-id="{{ r.empresa_id }}"
                               data-tear-id="{{ r.id }}">
                              <svg class="ic-building" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                <path d="M9 9h1M9 13h1M9 17h1M14 9h1M14 13h1M14 17h1"></path>
                              </svg>
                              <span class="lbl-full">Ver empresa</span>
                              <span class="lbl-short">Ver</span>
                            </a>
                            {% if r.contato %}
                              <a class="wa-link js-wa"
                                 href="{{ r.contato }}"
                                 target="_blank" rel="noopener"
                                 aria-label="WhatsApp"
                                 title="Contato via WhatsApp"
                                 data-company-id="{{ r.empresa_id }}"
                                 data-tear-id="{{ r.id }}">
                                <img class="wa-icon"
                                     src="/static/icone_whatsapp.png"
                                     data-alt="/static/ícone_whatsapp.png,/estatico/icone_whatsapp.png,/estático/ícone_whatsapp.png"
                                     alt="WhatsApp"
                                     onerror="(function(img){var s=img.getAttribute('data-alt');if(!s){img.onerror=null;return;}var a=s.split(',');img.setAttribute('data-alt', a.slice(1).join(','));img.src=a[0];})(this);">
                              </a>
                            {% endif %}
                          </div>
                        </div>
                        <div class="empresa-bottom" title="{{ (r.cidade or '') }}{% if r.uf %}/{{ r.uf }}{% endif %}">
                          <svg class="pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0Z"/>
                            <circle cx="12" cy="10" r="3"/>
                          </svg>
                          <span>{{ r.cidade }}{% if r.uf %}/{{ r.uf }}{% endif %}</span>
                        </div>
                      </div>
                    </article>
                  {% endfor %}
                </div>
              </div>

              <!-- TABELA (desktop) -->
              <div class="table-wrap desktop-only">
                <table class="teares-table">
                  <thead>
                    <tr>
                      <th>Empresa</th>
                      <th>Tipo</th>
                      <th>Galga</th>
                      <th>Diâmetro</th>
                      <th>Alimentadores</th>
                      <th>Kit elastano</th>
                      <th>UF</th>
                      <th>Cidade</th>
                      <th>Perfil / Contato</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in resultados %}
                      <tr>
                        <td class="cell-empresa">{{ r.empresa }}</td>
                        <td>{{ r.tipo }}</td>
                        <td>{{ r.galga }}</td>
                        <td>{{ r.diametro }}</td>
                        <td>{{ r.alimentadores }}</td>
                        <td>
                          {% set raw = r.elastano if (r is defined and (r.elastano is not none)) else r.kit_elastano %}
                          {% if raw is boolean %}
                            {{ 'Sim' if raw else 'Não' }}
                          {% else %}
                            {% set s = (raw|string).strip().lower() %}
                            {% if s in ['sim','s','true','t','on','1','com','tem','yes','y'] %}
                              Sim
                            {% elif s in ['não','nao','n','false','f','off','0','sem','no'] %}
                              Não
                            {% else %}
                              —
                            {% endif %}
                          {% endif %}
                        </td>
                        <td>{{ r.uf }}</td>
                        <td>{{ r.cidade }}</td>
                        <td>
                          <div style="display:flex;align-items:center;justify-content:center;gap:8px;">
                            <a class="btn-view js-view-company"
                               href="{{ url_for('empresa_perfil', empresa_id=r.empresa_id) }}"
                               title="Ver perfil da empresa"
                               aria-label="Ver perfil da empresa"
                               data-company-id="{{ r.empresa_id }}"
                               data-tear-id="{{ r.id }}">
                              <svg class="ic-building" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                <path d="M9 9h1M9 13h1M9 17h1M14 9h1M14 13h1M14 17h1"></path>
                              </svg>
                              Ver
                            </a>
                            {% if r.contato %}
                              <a href="{{ r.contato }}" target="_blank" rel="noopener"
                                 class="wa-link js-wa"
                                 aria-label="WhatsApp" title="Contato via WhatsApp"
                                 data-company-id="{{ r.empresa_id }}"
                                 data-tear-id="{{ r.id }}">
                                <img class="wa-icon"
                                     src="/static/icone_whatsapp.png"
                                     data-alt="/static/ícone_whatsapp.png,/estatico/icone_whatsapp.png,/estático/ícone_whatsapp.png"
                                     alt="WhatsApp"
                                     onerror="(function(img){var s=img.getAttribute('data-alt');if(!s){img.onerror=null;return;}var a=s.split(',');img.setAttribute('data-alt', a.slice(1).join(','));img.src=a[0];})(this);">
                              </a>
                            {% else %}
                              —
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <!-- PAGINAÇÃO -->
              {% set filtro_diam_ = filtros.get('diâmetro') or filtros.get('diametro') or '' %}
              <div class="pager">
                <div class="group">
                  <a class="btn-page" href="{{ url_for('index',
                        pagina=1, pp=por_pagina,
                        tipo=filtros.get('tipo',''),
                        diametro=filtro_diam_,
                        galga=filtros.get('galga',''),
                        estado=filtros.get('estado',''),
                        cidade=filtros.get('cidade','')) }}" aria-disabled="{{ 'true' if pagina==1 else 'false' }}">« Primeira</a>

                  <a class="btn-page" href="{{ url_for('index',
                        pagina=(pagina-1 if pagina>1 else 1), pp=por_pagina,
                        tipo=filtros.get('tipo',''),
                        diametro=filtro_diam_,
                        galga=filtros.get('galga',''),
                        estado=filtros.get('estado',''),
                        cidade=filtros.get('cidade','')) }}" aria-disabled="{{ 'true' if pagina==1 else 'false' }}">‹ Anterior</a>

                  <span class="info">Página {{ pagina }} de {{ total_paginas }}</span>

                  <a class="btn-page" href="{{ url_for('index',
                        pagina=(pagina+1 if pagina<total_paginas else total_paginas), pp=por_pagina,
                        tipo=filtros.get('tipo',''),
                        diametro=filtro_diam_,
                        galga=filtros.get('galga',''),
                        estado=filtros.get('estado',''),
                        cidade=filtros.get('cidade','')) }}" aria-disabled="{{ 'true' if pagina==total_paginas else 'false' }}">Próxima ›</a>

                  <a class="btn-page" href="{{ url_for('index',
                        pagina=total_paginas, pp=por_pagina,
                        tipo=filtros.get('tipo',''),
                        diametro=filtro_diam_,
                        galga=filtros.get('galga',''),
                        estado=filtros.get('estado',''),
                        cidade=filtros.get('cidade','')) }}" aria-disabled="{{ 'true' if pagina==total_paginas else 'false' }}">Última »</a>
                </div>

                <div class="group">
                  <label for="ppSelect" class="info">Itens por página:</label>
                  <select id="ppSelect">
                    <option value="20" {% if por_pagina==20 %}selected{% endif %}>20</option>
                    <option value="50" {% if por_pagina==50 %}selected{% endif %}>50</option>
                    <option value="100" {% if por_pagina==100 %}selected{% endif %}>100</option>
                  </select>
                </div>
              </div>
            {% else %}
              <div style="padding:8px 10px;">Nenhum tear encontrado para os filtros atuais.</div>
            {% endif %}
          </section>

        </div><!-- /right-col -->
      </form><!-- /filtrosForm -->

    </div><!-- /page-outer -->
  </div><!-- /faixa-cinza -->

  <!-- CTA -->
  <section class="cta-bar" aria-label="Convite para cadastro">
    <div class="cta-text">
      <h3>É proprietário de uma malharia?</h3>
      <p>Cadastre sua malharia e comece a receber novos pedidos.</p>
    </div>
    <a href="/cadastrar_empresa" class="cta-btn">Cadastrar</a>
  </section>

  <!-- Rodapé -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-brand"><img src="/static/logo_simbolo.png" alt="AcheTece"></div>
      <div class="footer-cols">
        <div class="footer-col">
          <h4>Sobre nós</h4>
          <ul>
            <li><a href="{{ url_for('view_quem_somos') }}">O AcheTece</a></li>
            <li><a href="{{ url_for('malharia_info') }}">Como funciona</a></li>
            <li><a href="{{ url_for('contato') }}">Fale conosco</a></li>
            <li><a href="{{ url_for('termos') }}">Termos e Políticas</a></li>
          </ul>
        </div>
        <div class="footer-col"><h4>&nbsp;</h4><ul><li>&nbsp;</li></ul></div>
      </div>
    </div>
  </footer>

  <!-- ===== JS ===== -->
  <script>
    // Auto-aplicar filtros
    (function(){
      const form = document.getElementById('filtrosForm');
      const paginaHidden = document.getElementById('pagina_hidden');
      function submitResetPage(){ if(paginaHidden) paginaHidden.value='1'; if(form) form.submit(); }
      document.addEventListener('change', e=>{ if(e.target.matches('select.auto-apply')) submitResetPage(); });
      let t=null;
      document.addEventListener('input', e=>{
        if(e.target.matches('input.auto-apply')){ clearTimeout(t); t=setTimeout(submitResetPage,500); }
      });
    })();

    // Gaveta de filtros no mobile
    (function(){
      const openBtn=document.getElementById('openFiltersBtn');
      const closeBtn=document.getElementById('closeFiltersBtn');
      const panel=document.getElementById('filtersPanel');
      const backdrop=document.getElementById('filtersBackdrop');
      function open(){ document.body.classList.add('filters-open'); panel.classList.add('is-open'); if(openBtn) openBtn.setAttribute('aria-expanded','true'); }
      function close(){ document.body.classList.remove('filters-open'); panel.classList.remove('is-open'); if(openBtn) openBtn.setAttribute('aria-expanded','false'); }
      if(openBtn) openBtn.addEventListener('click', open);
      if(closeBtn) closeBtn.addEventListener('click', close);
      if(backdrop) backdrop.addEventListener('click', close);
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
    })();

    // Itens por página
    (function(){
      const ppSel=document.getElementById('ppSelect'); const ppHidden=document.getElementById('pp_hidden');
      if(!ppSel) return;
      ppSel.addEventListener('change', ()=>{
        if(ppHidden) ppHidden.value=ppSel.value;
        const url=new URL(window.location);
        url.searchParams.set('pp', ppSel.value);
        url.searchParams.set('pagina', '1');
        window.location = url.toString();
      });
    })();

    // ===== Analytics simples: view_company e wa_click =====
    (function(){
      function sendEvent(payload){
        try{
          const url = "/analytics/event";
          const str = JSON.stringify(payload);
          if (navigator.sendBeacon) {
            const blob = new Blob([str], {type:"application/json"});
            navigator.sendBeacon(url, blob);
          } else {
            fetch(url, {method:"POST", headers:{'Content-Type':'application/json'}, body:str, keepalive:true}).catch(()=>{});
          }
        }catch(e){ }
      }

      document.addEventListener('click', function(e){
        const view = e.target.closest('.js-view-company');
        if (view){
          sendEvent({
            type: 'view_company',
            company_id: view.getAttribute('data-company-id'),
            tear_id: view.getAttribute('data-tear-id'),
            source: 'index'
          });
        }
        const wa = e.target.closest('.js-wa');
        if (wa){
          sendEvent({
            type: 'wa_click',
            company_id: wa.getAttribute('data-company-id'),
            tear_id: wa.getAttribute('data-tear-id'),
            source: 'index'
          });
        }
      });
    })();

    // ===== UF/Cidade com lista completa (IBGE) =====
    (function(){
      const estadoSel = document.getElementById('estado');
      const cidadeSel = document.getElementById('cidade');

      const CITIES_CACHE = Object.create(null);

      async function fetchCities(uf){
        if (!uf) return [];
        if (CITIES_CACHE[uf]) return CITIES_CACHE[uf];
        const url = 'https://servicodados.ibge.gov.br/api/v1/localidades/estados/'+ uf +'/municipios?orderBy=nome';
        const resp = await fetch(url, {mode:'cors'});
        const data = await resp.json();
        const names = (Array.isArray(data) ? data.map(x=>x.nome) : []).sort((a,b)=>a.localeCompare(b,'pt-BR'));
        CITIES_CACHE[uf] = names;
        return names;
      }

      function clearAndBaseOption(select, text){
        select.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = text || 'Todas';
        select.appendChild(opt);
      }

      async function loadCities(uf, preselect){
        if (!cidadeSel) return;
        clearAndBaseOption(cidadeSel, uf ? 'Todas' : 'Selecione o estado primeiro');
        cidadeSel.disabled = !uf;
        if (!uf) return;

        try{
          const list = await fetchCities(uf);
          for (const name of list){
            const o = new Option(name, name, false, false);
            cidadeSel.add(o);
          }
          if (preselect){
            cidadeSel.value = preselect;
          }
        }catch(err){
          clearAndBaseOption(cidadeSel, 'Falha ao carregar cidades');
          cidadeSel.disabled = false;
        }
      }

      // Inicializa conforme valores atuais vindos do servidor
      if (estadoSel && cidadeSel){
        const preUF = estadoSel.value || '';
        const preCity = cidadeSel.getAttribute('data-selected') || '';
        if (preUF){
          loadCities(preUF, preCity);
        } else {
          clearAndBaseOption(cidadeSel, 'Selecione o estado primeiro');
          cidadeSel.disabled = true;
        }

        estadoSel.addEventListener('change', function(){
          // auto-apply já submete o form; mantém comportamento padrão
        });
      }
    })();
  </script>

</body>
</html>
