<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Perfil da Malharia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon_final.png') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    :root{
      --bg:#F7F7FA;
      --card:#ffffff;
      --line:#e9e9ee;
      --text:#111318;
      --muted:#70737c;
      --accent:#5B2FFF;             /* roxo discreto p/ links */
      --accent-soft:#F3F0FF;         /* roxo bem clarinho */
      --pill:#F0F1F4;                /* cinza claro do pill */
      --shadow:0 6px 20px rgba(0,0,0,.06);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{max-width:1100px;margin:0 auto;padding:16px; overflow-x:hidden}

    /* Navbar minimal */
    .navbar{padding:8px 12px;background:var(--card);border-bottom:1px solid var(--line)}
    .logo a{display:inline-flex;align-items:center}
    .logo img{height:44px;width:auto;display:block}

    /* Cards */
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px; margin:14px 0;
    }

    /* Header da empresa */
    .head{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;
    }
    .title{margin:0;font-size:24px;font-weight:800}
    .sub{margin:6px 0 0;color:var(--muted);font-weight:600}
    /* pill cinza claro, texto escuro */
    .pill{
      display:inline-flex;align-items:center;height:26px;padding:0 10px;border-radius:9999px;
      background:var(--pill);border:1px solid #e7e8ec;font-size:12.5px;font-weight:800;color:#222;
    }
    .pill-row{margin-top:8px}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 14px;
      border-radius:9999px;border:1px solid var(--line);background:#fff;color:var(--text);font-weight:800;
      transition:.18s ease;
    }
    /* botão não sublinha no hover */
    .btn:hover{background:var(--accent-soft);border-color:#e6e1ff;color:#3e2ac1;text-decoration:none}
    .btn:focus-visible{outline:3px solid rgba(91,47,255,.25)}
    .btn-icon{height:38px;padding:0 12px}

    /* Ícone Whats P&B */
    .svg{width:18px;height:18px;display:inline-block;vertical-align:middle;flex:0 0 18px}
    .btn-ghost{border-color:transparent;background:transparent;color:var(--text)}
    .btn-ghost:hover{background:#f0f0f3;color:#000;text-decoration:none}

    /* Layout mobile do header: conteúdo à esquerda, ações à direita */
    @media (max-width:640px){
      .head{
        display:grid;
        grid-template-columns: 1fr max-content;
        align-items:start;
      }
      .actions{grid-column:2 / 3; grid-row:1 / span 3; align-self:start}
    }

    /* Seção informações da empresa */
    .sec-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 0 10px}
    h2.sec{margin:0;font-size:20px;font-weight:800}
    .maps-link{display:inline-flex;align-items:center;gap:8px;font-weight:800;color:var(--accent)}
    .maps-link .svg{width:19px;height:19px}
    /* Versão que aparece só no mobile, perto do mapa */
    .maps-link--inline{display:none;margin:8px 10px 0}

    .empresa-grid{display:grid;grid-template-columns:1.2fr .9fr;gap:18px;align-items:start}
    @media (max-width:900px){ .empresa-grid{grid-template-columns:1fr} }

    .dados{
      display:grid; grid-template-columns:180px 1fr; gap:10px 14px;
      border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff;
    }
    /* no mobile: rótulo e valor em linha (2 colunas), exceto endereço quebra a linha naturalmente */
    @media (max-width:640px){ .dados{grid-template-columns:132px 1fr} }

    .dados dt{
      font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); font-weight:900;
    }
    .dados dd{
      margin:0; font-size:15px; font-weight:600; color:var(--text); min-width:0;
    }
    .v{display:block; line-height:1.45; color:var(--text); font-weight:700; font-size:16px}
    .v--soft{font-weight:600; font-size:15px}
    .dados dd, .dados a{word-break:break-word; overflow-wrap:anywhere}

    .addr .linha{display:block}
    .addr .rua{font-weight:700}
    .addr .local, .addr .cep{color:var(--text); font-weight:600} /* mesma cor do endereço */

    /* Mapa */
    .mapa{border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#fff}
    .mapa iframe{width:100%; height:220px; border:0; display:block}
    @media (max-width:640px){ .mapa iframe{height:180px} }
    .mapa small{display:block; padding:8px 10px; color:#666}

    /* Mostrar/ocultar "Ver no Maps" certo por breakpoint */
    @media (max-width:900px){
      .maps-link{display:none}
      .maps-link--inline{display:inline-flex}
    }

    /* Teares (cards) */
    .teares-grid{
      display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .tear{
      border:1px solid var(--line); border-radius:14px; background:#fff; box-shadow:0 4px 14px rgba(0,0,0,.04);
      overflow:hidden;
    }
    /* barra superior roxo bem clarinho com o Tipo */
    .tear-head{
      background:var(--accent-soft);
      padding:10px 12px;
      border-bottom:1px solid #ece8ff;
    }
    .tear-head .k{color:#6459c6;font-weight:800;font-size:12px;letter-spacing:.04em;text-transform:uppercase; margin-right:6px}
    .tear-head .v{display:inline;font-weight:900;font-size:16px}

    .tear-body{padding:12px}
    .kv{display:grid; grid-template-columns:1fr 1fr; gap:8px 12px}
    .kv .k{color:var(--muted); font-weight:700}
    .kv .v{font-weight:800; font-size:16px}
    @media (max-width:520px){ .kv{grid-template-columns:1fr 1fr} }

    .footer-spacer{height:8px}
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">
      <a href="{{ url_for('index') }}" aria-label="Página inicial">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="AcheTece">
      </a>
    </div>
  </header>

  <main class="wrap">
    <!-- Cabeçalho -->
    <section class="card">
      <div class="head">
        <div>
          <h1 class="title">{{ empresa.apelido or empresa.nome_fantasia or empresa.razao_social or 'Malharia' }}</h1>
          <p class="sub">
            {% if empresa.cidade %}{{ empresa.cidade }}{% if empresa.estado %}/{{ empresa.estado }}{% endif %}{% endif %}
          </p>
          {% if teares %}
            <div class="pill-row"><span class="pill">{{ teares|length }} tear(es)</span></div>
          {% endif %}
        </div>
        <div class="actions">
          {# Whats (preto e branco) #}
          {% set _fone = empresa.telefone or empresa.contato_telefone or empresa.celular %}
          {% set _wa = empresa.contato_whatsapp or (('https://wa.me/' ~ ('55' ~ _fone|replace(' ','')|replace('(','')|replace(')','')|replace('-','') if _fone and not (_fone|replace(' ','')|replace('(','')|replace(')','')|replace('-','') ).startswith('55') else _fone|replace(' ','')|replace('(','')|replace(')','')|replace('-',''))) if _fone else None) %}
          {% if _wa %}
            <a class="btn btn-ghost btn-icon" href="{{ _wa }}" target="_blank" rel="noopener" aria-label="WhatsApp">
              <svg class="svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M20.52 3.48A11.77 11.77 0 0 0 12.01 0C5.4 0 .03 5.37.03 12c0 2.11.55 4.17 1.6 5.99L0 24l6.19-1.61A11.93 11.93 0 0 0 12 24c6.62 0 12-5.37 12-12 0-3.21-1.25-6.23-3.48-8.52Zm-8.51 18.2a9.9 9.9 0 0 1-5.05-1.39l-.36-.21-3.68.96.98-3.58-.23-.37A9.92 9.92 0 1 1 21.9 12c0 5.46-4.44 9.68-9.89 9.68Zm5.68-7.25c-.31-.16-1.83-.9-2.11-1.01-.28-.11-.48-.16-.68.16-.2.31-.78 1.01-.96 1.22-.18.21-.36.23-.66.08-.31-.16-1.31-.48-2.49-1.52-.92-.82-1.54-1.82-1.72-2.13-.18-.31-.02-.48.13-.64.14-.14.31-.36.47-.54.16-.18.21-.31.31-.52.1-.21.05-.39-.03-.55-.08-.16-.68-1.63-.93-2.24-.24-.58-.49-.5-.68-.51l-.58-.01c-.2 0-.52.08-.79.39-.27.31-1.04 1.02-1.04 2.49 0 1.47 1.07 2.9 1.22 3.1.15.2 2.12 3.24 5.14 4.54.72.31 1.28.5 1.71.64.72.23 1.38.2 1.9.12.58-.09 1.83-.75 2.09-1.47.26-.72.26-1.33.18-1.46-.08-.13-.28-.21-.59-.37Z"/>
              </svg>
            </a>
          {% endif %}
          <a class="btn" href="{{ url_for('index') }}">Voltar</a>
        </div>
      </div>
    </section>

    {# ==== Endereço e Maps ==== #}
    {% set _logradouro = empresa.endereco or empresa.logradouro or empresa.endereco_completo %}
    {% set _numero     = empresa.numero %}
    {% set _bairro     = empresa.bairro %}
    {% set _cidade     = empresa.cidade %}
    {% set _estado     = empresa.estado %}
    {% set _cep        = empresa.cep %}
    {% set tem_end = _logradouro or _numero or _bairro or _cidade or _estado or _cep %}
    {% set endereco_full = (
      (_logradouro or '') ~
      (', ' ~ _numero if _numero else '') ~
      (', ' ~ _bairro if _bairro else '') ~
      (', ' ~ _cidade if _cidade else '') ~
      ( '/' ~ _estado if _estado else '') ~
      ( ' • CEP ' ~ _cep if _cep else '')
    ).strip().strip(',') %}
    {% set mapa_q = (endereco_full or ((_cidade or '') ~ ' ' ~ (_estado or ''))) | replace(' ', '+') %}
    {% set map_url = 'https://www.google.com/maps?q=' ~ mapa_q %}

    <section class="card">
      <div class="sec-head">
        <h2 class="sec">Informações da empresa</h2>
        {% if tem_end %}
          <a class="maps-link" href="{{ map_url }}" target="_blank" rel="noopener">
            <svg class="svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 2C7.86 2 4.5 5.36 4.5 9.5c0 5.25 7.5 12 7.5 12s7.5-6.75 7.5-12C19.5 5.36 16.14 2 12 2Zm0 10.5a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"/>
            </svg>
            Ver no Maps
          </a>
        {% endif %}
      </div>

      <div class="empresa-grid">
        <dl class="dados">
          {% set _pn = empresa.contato_nome or empresa.responsavel_nome or empresa.responsavel %}
          {% set _sn = empresa.contato_sobrenome or empresa.responsavel_sobrenome %}
          {% set pessoa_contato = ((_pn or '') ~ (' ' ~ _sn if _sn else '')).strip() %}
          <dt>Pessoa de contato</dt>
          <dd><span class="v">{{ pessoa_contato if pessoa_contato else '—' }}</span></dd>

          <dt>Telefone</dt>
          <dd>
            {% set _fone = empresa.telefone or empresa.contato_telefone or empresa.celular %}
            {% if _fone %}
              {% set fraw = _fone|replace(' ','')|replace('(','')|replace(')','')|replace('-','') %}
              {% if fraw.startswith('55') %}{% set fraw = fraw[2:] %}{% endif %}
              {% set ddd = fraw[:2] %}
              {% set resto = fraw[2:] %}
              {% if resto|length == 9 %}
                {% set p1 = resto[:5] %}{% set p2 = resto[5:] %}
              {% else %}
                {% set p1 = resto[:4] %}{% set p2 = resto[4:] %}
              {% endif %}
              {% set display = '(' ~ ddd ~ ') ' ~ p1 ~ '-' ~ p2 %}
              {% set telhref = 'tel:' ~ ('55' ~ fraw if not fraw.startswith('55') else fraw) %}
              <a href="{{ telhref }}">{{ display }}</a>
            {% else %}—{% endif %}
          </dd>

          <dt>E-mail</dt>
          <dd>
            {% set _email = empresa.email or empresa.contato_email %}
            {% if _email %}
              <a href="mailto:{{ _email }}"><span class="v--soft">{{ _email }}</span></a>
            {% else %}—{% endif %}
          </dd>

          <dt>Endereço</dt>
          <dd>
            {% if tem_end %}
              <div class="addr">
                <span class="linha rua v">
                  {{ _logradouro or '' }}{% if _numero %}, {{ _numero }}{% endif %}{% if _bairro %} – {{ _bairro }}{% endif %}
                </span>
                <span class="linha local v--soft">
                  {{ _cidade or '' }}{% if _estado %}/{{ _estado }}{% endif %}
                  {% if _cep %}<span class="cep"> • CEP {{ _cep }}</span>{% endif %}
                </span>
              </div>
            {% else %}—{% endif %}
          </dd>
        </dl>

        <div class="mapa">
          {% if tem_end %}
            <!-- Link "Ver no Maps" perto do mapa (só mobile) -->
            <a class="maps-link maps-link--inline" href="{{ map_url }}" target="_blank" rel="noopener">
              <svg class="svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 2C7.86 2 4.5 5.36 4.5 9.5c0 5.25 7.5 12 7.5 12s7.5-6.75 7.5-12C19.5 5.36 16.14 2 12 2Zm0 10.5a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"/>
              </svg>
              Ver no Maps
            </a>
            <iframe loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="{{ map_url }}&output=embed" title="Mapa"></iframe>
            <small>Localização aproximada com base no endereço cadastrado.</small>
          {% else %}
            <div style="padding:14px;">Sem endereço cadastrado para exibir no mapa.</div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Teares da malharia -->
    <section class="card">
      <h2 class="sec" style="margin-bottom:10px">Teares desta malharia</h2>

      {% if teares and teares|length %}
        <div class="teares-grid" role="region" aria-label="Lista de teares">
          {% for t in teares %}
            <article class="tear">
              <div class="tear-head">
                <span class="k">Tipo:</span> <span class="v">{{ t.tipo or '—' }}</span>
              </div>
              <div class="tear-body">
                <div class="kv">
                  <div>
                    <div class="k">Diâmetro</div>
                    <div class="v">{{ t.diametro or '—' }}</div>
                  </div>
                  <div>
                    <div class="k">Galga</div>
                    <div class="v">{{ t.finura or t.galga or '—' }}</div>
                  </div>
                  <div>
                    <div class="k">Alimentadores</div>
                    <div class="v">{{ t.alimentadores or '—' }}</div>
                  </div>
                  <div>
                    <div class="k">Elastano</div>
                    <div class="v">
                      {% set raw = t.elastano if (t.elastano is not none) else t.kit_elastano %}
                      {% if raw is boolean %}
                        {{ 'Sim' if raw else 'Não' }}
                      {% else %}
                        {% set s = (raw|string).strip().lower() %}
                        {% if s in ['sim','s','true','t','on','1','com','tem','yes','y'] %}Sim
                        {% elif s in ['não','nao','n','false','f','off','0','sem','no'] %}Não
                        {% else %}—{% endif %}
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div>Nenhum tear cadastrado para esta empresa.</div>
      {% endif %}
    </section>

    <div class="footer-spacer"></div>
  </main>
</body>
</html>
